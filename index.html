<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Keiketsu Simple – 学習だけ版</title>
<style>
  :root{
    --bg:#0f172a;       /* slate-900 */
    --panel:#111827;    /* gray-900 */
    --muted:#94a3b8;    /* slate-400 */
    --text:#e5e7eb;     /* gray-200 */
    --accent:#22d3ee;   /* cyan-400 */
    --ok:#22c55e;       /* green-500 */
    --ng:#ef4444;       /* red-500 */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1220,#0f172a);
    color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;
  }
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{font-size:20px;margin:0 0 12px;font-weight:700;letter-spacing:.02em}
  .bar{
    display:grid; gap:8px; grid-template-columns:repeat(6,minmax(0,1fr));
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
  }
  .bar > div{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  select,input[type="number"]{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:#0b1220; color:var(--text); outline:none;
  }
  .row{display:flex;align-items:center;gap:8px}
  .row input[type="checkbox"]{transform:scale(1.2)}
  .btn{
    cursor:pointer; user-select:none; border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg,#1f2937,#111827); color:var(--text);
    padding:10px 14px; border-radius:12px; font-weight:600; letter-spacing:.02em;
    transition:.15s; text-align:center;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .btn.accent{border-color:rgba(34,211,238,.6); box-shadow:0 0 0 1px rgba(34,211,238,.25) inset}
  .btn.ok{border-color:rgba(34,197,94,.6)}
  .btn.ng{border-color:rgba(239,68,68,.6)}

  .card{
    margin-top:14px; background:linear-gradient(180deg,#0b1220,#0c1426);
    border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:18px;
  }
  .q{font-size:18px;margin:6px 0 8px;font-weight:700}
  .a{white-space:pre-wrap;line-height:1.65;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:12px;min-height:48px}
  .sub{color:var(--muted);font-size:12px;margin-top:6px}
  .mcq{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  .mcq .btn{width:100%}
  .mcq .btn.correct{outline:2px solid var(--ok)}
  .mcq .btn.wrong{outline:2px solid var(--ng)}

  .progress{margin-top:10px;color:var(--muted);font-size:13px}
  .toast{
    position:fixed; left:50%; bottom:20px; transform:translateX(-50%) translateY(16px);
    background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.16);
    padding:8px 12px; border-radius:999px; opacity:0; transition:.2s; pointer-events:none
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  .grid-ops{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
  @media (min-width:760px){
    .mcq{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Keiketsu Simple（学習だけ版）</h1>

  <!-- コントロールバー -->
  <div class="bar">
    <div>
      <label for="preset">出題形式</label>
      <select id="preset">
        <option value="name->location">経穴名 → 位置</option>
        <option value="location->name">位置 → 経穴名</option>
        <option value="code->name">コード → 経穴名</option>
        <option value="name->indications">経穴名 → 主治</option>
        <option value="code->location">コード → 位置</option>
      </select>
    </div>
    <div>
      <label for="mode">モード</label>
      <select id="mode">
        <option value="flash">フラッシュカード</option>
        <option value="mcq">四択クイズ</option>
      </select>
    </div>
    <div>
      <label for="order">順序</label>
      <select id="order">
        <option value="random">ランダム</option>
        <option value="code">コード順（CV→GV→十二正経）</option>
      </select>
    </div>
    <div>
      <label for="limit">出題数</label>
      <input id="limit" type="number" min="1" step="1" value="20" />
      <div class="row"><input id="useMax" type="checkbox" /><label for="useMax">最大（全件）</label></div>
    </div>
    <div>
      <label>再出題</label>
      <div class="row"><input id="requeue" type="checkbox" checked /><label for="requeue">間違えを最後に再出題</label></div>
    </div>
    <div style="align-self:end;display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button id="btnStart" class="btn accent" type="button">開始</button>
      <button id="btnEnd" class="btn" type="button">終了</button>
    </div>
  </div>

  <!-- 学習カード -->
  <div class="card" id="card">
    <div id="q" class="q">「開始」を押してください</div>
    <div id="a" class="a"></div>
    <div id="sub" class="sub">クリック / Enter / Space で裏返し（フラッシュカード時）</div>

    <!-- 四択 -->
    <div id="mcq" class="mcq" style="display:none"></div>

    <!-- 操作 -->
    <div class="grid-ops">
      <button id="btnShow" class="btn" type="button">表示 / 裏返し</button>
      <button id="btnOK" class="btn ok" type="button">正解</button>
      <button id="btnNG" class="btn ng" type="button">不正解</button>
      <button id="btnNext" class="btn" type="button">次へ</button>
    </div>

    <div id="progress" class="progress"></div>
  </div>
</div>

<!-- トースト -->
<div id="toast" class="toast"></div>

<!-- 初期サンプル（10穴・英語キー固定） -->
<script type="application/json" id="seedData">
[
  {"code":"LU1","name":"中府","meridian":"手の太陰肺経","reading":"ちゅうふ","location":"前胸部・第1肋間、前正中線から外方6寸。","indications":"咳、喘息、胸痛、肩前部痛","memo":"","shu":"井","phase":"木"},
  {"code":"LI4","name":"合谷","meridian":"手の陽明大腸経","reading":"ごうこく","location":"手背、第1・第2中手骨間の中点。","indications":"頭痛、顔面痛、歯痛、発熱（妊婦禁忌）","memo":"","shu":"","phase":""},
  {"code":"ST36","name":"足三里","meridian":"足の陽明胃経","reading":"あしさんり","location":"犢鼻の下3寸、脛骨前縁の外側。","indications":"胃腸症状全般、疲労回復、免疫向上","memo":"","shu":"合","phase":"土"},
  {"code":"SP6","name":"三陰交","meridian":"足の太陰脾経","reading":"さんいんこう","location":"内果上3寸、脛骨内縁後方。","indications":"月経不順、不妊、泌尿器疾患","memo":"","shu":"","phase":""},
  {"code":"HT7","name":"神門","meridian":"手の少陰心経","reading":"しんもん","location":"手関節横紋尺側端、尺側手根屈筋腱の橈側。","indications":"不眠、動悸、精神不安","memo":"","shu":"兪","phase":""},
  {"code":"SI3","name":"後谿","meridian":"手の太陽小腸経","reading":"こうけい","location":"第5中手指節関節の後方陥凹部。","indications":"頭痛、項強、腰背痛","memo":"","shu":"","phase":""},
  {"code":"BL40","name":"委中","meridian":"足の太陽膀胱経","reading":"いちゅう","location":"膝窩横紋の中央。","indications":"腰痛、坐骨神経痛、皮膚疾患","memo":"","shu":"合","phase":""},
  {"code":"KI3","name":"太谿","meridian":"足の少陰腎経","reading":"たいけい","location":"内果とアキレス腱の間の陥凹部。","indications":"腰痛、不眠、耳鳴","memo":"","shu":"","phase":""},
  {"code":"PC6","name":"内関","meridian":"手の厥陰心包経","reading":"ないかん","location":"手関節横紋の上2寸、2本腱の間。","indications":"悪心、胸悶、不安、不眠","memo":"","shu":"","phase":""},
  {"code":"GV20","name":"百会","meridian":"督脈","reading":"ひゃくえ","location":"頭頂、両耳尖を結ぶ線の正中。","indications":"頭痛、めまい、不眠、脱肛","memo":"","shu":"","phase":""}
]
</script>

<script>
/* ========= ユーティリティ ========= */
const $ = id => document.getElementById(id);
const toast = (msg)=>{ const el=$('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove('show'),1400); };

const PRESETS = {
  'name->location': {q:'name', a:'location'},
  'location->name': {q:'location', a:'name'},
  'code->name':     {q:'code', a:'name'},
  'name->indications': {q:'name', a:'indications'},
  'code->location': {q:'code', a:'location'}
};

// コード順：CV → GV → LU → LI → ST → SP → HT → SI → BL → KI → PC → SJ → GB → LV
const PREFIX_ORDER = ['CV','GV','LU','LI','ST','SP','HT','SI','BL','KI','PC','SJ','GB','LV'];
const RANK = Object.fromEntries(PREFIX_ORDER.map((p,i)=>[p,i]));
function parseCode(s){
  const m = String(s||'').toUpperCase().replace('-','').match(/^([A-Z]+)(\d+)$/);
  if(!m) return {p:'', n:1e9, raw:String(s||'')};
  return {p:m[1], n:parseInt(m[2],10), raw:m[0]};
}
function codeCompare(a,b){
  const A=parseCode(a.code), B=parseCode(b.code);
  const ra = (A.p in RANK)?RANK[A.p]:999, rb = (B.p in RANK)?RANK[B.p]:999;
  if(ra!==rb) return ra-rb;
  if(A.n!==B.n) return A.n-B.n;
  return (A.raw).localeCompare(B.raw);
}

/* ========= データ読み込み ========= */
let pool = [];
(function loadSeed(){
  try{
    const raw = $('seedData').textContent.trim();
    pool = JSON.parse(raw);
  }catch(e){
    pool = [];
    alert('初期データ読み込みエラー: '+ e.message);
  }
})();

/* ========= セッション状態 ========= */
const S = {
  list:[], i:0, started:false,
  mode:'flash', showing:false,
  qKey:'name', aKey:'location',
  requeue:true, order:'random',
  correct:0, wrong:0
};

function labelOf(k){
  return ({code:'コード', name:'経穴名', location:'位置', indications:'主治'})[k] || k;
}

/* ========= 画面更新 ========= */
function clearUI(){
  $('q').textContent='「開始」を押してください';
  $('a').textContent='';
  $('sub').textContent='クリック / Enter / Space で裏返し（フラッシュカード時）';
  $('mcq').style.display='none';
  $('mcq').innerHTML='';
  $('progress').textContent='';
  S.showing=false;
}

function setQA(qText, aHtml=''){
  $('q').textContent=qText;
  $('a').innerHTML=aHtml;
}

function updateProgress(){
  $('progress').textContent = `進捗：${Math.min(S.i+1, S.list.length)}/${S.list.length}（正 ${S.correct}・誤 ${S.wrong}）`;
}

function showFront(){
  const it = S.list[S.i];
  setQA(`${labelOf(S.qKey)}：${it[S.qKey]||'—'}`, '');
  $('sub').textContent = 'クリック / Enter / Space で裏面表示';
  $('mcq').style.display='none';
  S.showing=false;
}

function showBack(){
  const it = S.list[S.i];
  const meta = [
    (it.code||''), (it.meridian||'')
  ].filter(Boolean).join(' / ');
  const body = [
    meta && `<div><b>${meta}</b></div>`,
    `経穴名：${it.name||'—'}`,
    `位置：${it.location||'—'}`,
    `主治：${it.indications||'—'}`,
    it.memo?`メモ：${it.memo}`:''
  ].filter(Boolean).join('\n');
  setQA(`${labelOf(S.aKey)}：${it[S.aKey]||'—'}`, body);
  $('sub').textContent = 'もう一度で表へ';
  $('mcq').style.display='none';
  S.showing=true;
}

function flip(){
  if(!S.started) { toast('先に「開始」してください'); return; }
  if(S.mode!=='flash') return;
  S.showing ? showFront() : showBack();
}

/* ========= MCQ ========= */
function buildMCQ(){
  const it = S.list[S.i];
  const area = $('mcq');
  area.innerHTML=''; area.style.display='grid';
  const poolA = Array.from(new Set(pool.map(x=>x[S.aKey]).filter(v=>String(v||'').trim()))); // 候補文字列集合
  const correct = it[S.aKey]||'—';
  const opts = [correct];

  // ダミーを追加
  while(opts.length<4 && poolA.length){
    const j = Math.floor(Math.random()*poolA.length);
    const cand = poolA.splice(j,1)[0];
    if(!opts.includes(cand)) opts.push(cand);
  }
  while(opts.length<4) opts.push(correct);

  // シャッフル
  for(let i=opts.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [opts[i],opts[j]]=[opts[j],opts[i]];
  }

  // 配置
  opts.forEach(text=>{
    const b=document.createElement('button');
    b.className='btn';
    b.type='button';
    b.textContent=text;
    b.onclick=()=>{
      if(b.dataset.done) return;
      if(text===correct){ b.classList.add('correct'); S.correct++; toast('正解'); }
      else { b.classList.add('wrong'); S.wrong++; if(S.requeue) S.list.push(it); toast('不正解'); }
      b.dataset.done='1';
      setTimeout(next, 280);
    };
    area.appendChild(b);
  });

  setQA(`${labelOf(S.qKey)}：${it[S.qKey]||'—'}`, '');
  $('sub').textContent='';
}

/* ========= フロー ========= */
function prepareList(){
  // 設定反映
  const p = PRESETS[$('preset').value] || PRESETS['name->location'];
  S.qKey=p.q; S.aKey=p.a;
  S.mode = $('mode').value;
  S.requeue = $('requeue').checked;
  S.order = $('order').value;

  // 有効なQ/Aが揃っているものだけ
  let arr = pool.filter(x=> String(x[S.qKey]||'').trim() && String(x[S.aKey]||'').trim());

  // 並び順
  if(S.order==='code') arr.sort(codeCompare);
  else {
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  // 出題数
  const useMax = $('useMax').checked;
  let n = parseInt($('limit').value||'20',10);
  if(!(n>0)) n=20;
  const take = useMax ? arr.length : Math.min(Math.max(1,n), arr.length);
  return arr.slice(0,take);
}

function start(){
  // UIリセット
  clearUI();

  const list = prepareList();
  if(!list.length){
    $('q').textContent='出題可能なデータがありません（形式とサンプルをご確認ください）';
    return;
  }
  S.list=list; S.i=0; S.correct=0; S.wrong=0; S.started=true; S.showing=false;

  if(S.mode==='mcq') buildMCQ();
  else showFront();
  updateProgress();
  toast('開始しました');
}

function end(){
  if(!S.started){ clearUI(); return; }
  S.started=false;
  $('q').textContent='セッション終了';
  $('a').textContent=`正解 ${S.correct} / 不正解 ${S.wrong}`;
  $('sub').textContent='';
  $('mcq').style.display='none';
  $('progress').textContent='';
}

function next(){
  if(!S.started) return;
  S.i++;
  if(S.i>=S.list.length){
    $('q').textContent='セッション完了！';
    $('a').textContent=`正解 ${S.correct} / 不正解 ${S.wrong}`;
    $('sub').textContent='';
    $('mcq').style.display='none';
    $('progress').textContent='';
    S.started=false;
    toast('おつかれさま！');
    return;
  }
  if(S.mode==='mcq') buildMCQ(); else showFront();
  updateProgress();
}

function mark(ok){
  if(!S.started){ toast('先に「開始」してください'); return; }
  const it = S.list[S.i];
  if(ok){ S.correct++; toast('正解'); }
  else { S.wrong++; if(S.requeue) S.list.push(it); toast('不正解'); }
  next();
}

/* ========= イベント ========= */
$('btnStart').addEventListener('click', start);
$('btnEnd').addEventListener('click', end);
$('btnShow').addEventListener('click', flip);
$('btnNext').addEventListener('click', next);
$('btnOK').addEventListener('click', ()=>mark(true));
$('btnNG').addEventListener('click', ()=>mark(false));

// カードクリックで裏返し（フラッシュ時のみ）
$('card').addEventListener('click', e=>{
  // ボタンのクリックは除外
  if(e.target.closest('.btn')) return;
  flip();
});

// キー操作（Enter/Space）
document.addEventListener('keydown', e=>{
  if(e.key==='Enter' || e.key===' '){
    e.preventDefault();
    flip();
  }
});

</script>
</body>
</html>
