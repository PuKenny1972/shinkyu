<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>経穴学習アプリ v9.5</title>
<style>
  body { font-family: sans-serif; margin: 0; padding: 0; }
  header { background: #4682b4; color: white; padding: 0.5em; text-align: center; }
  nav { display: flex; background: #eee; }
  nav button { flex: 1; padding: 0.8em; border: none; background: #ddd; cursor: pointer; font-size: 1em; }
  nav button.active { background: #fff; border-bottom: 2px solid #4682b4; }
  section { display: none; padding: 1em; }
  section.active { display: block; }
  table { border-collapse: collapse; width: 100%; min-width: 1200px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 4px; font-size: 0.9em; }
  th { background: #f0f0f0; }
  td[contenteditable="true"] { background: #ffffe0; }
  .btn { margin: 2px; padding: 2px 6px; font-size: 0.8em; }
  #toast { visibility: hidden; min-width: 160px; margin-left: -80px; background: #333; color: #fff;
           text-align: center; border-radius: 2px; padding: 8px; position: fixed; z-index: 1;
           left: 50%; bottom: 30px; }
  #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 1.5s; }
  @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
  @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
</style>
</head>
<body>
<header><h1>経穴学習アプリ v9.5</h1></header>
<nav>
  <button id="btnStudy" class="active">学習</button>
  <button id="btnManage">データ管理</button>
  <button id="btnAbout">説明</button>
</nav>

<!-- 学習 -->
<section id="study" class="active">
  <p>
    出題形式:
    <select id="qaPreset">
      <option value="name->location">経穴名 → 位置</option>
      <option value="code->name">コード → 経穴名</option>
      <option value="name->indications">経穴名 → 主治</option>
      <option value="location->name">位置 → 経穴名</option>
    </select>
    出題数: <input type="number" id="limit" value="20" min="1" style="width:4em">
    <label><input type="checkbox" id="chkMax"> 最大</label>
    並び順:
    <select id="order">
      <option value="random">ランダム</option>
      <option value="code">コード順</option>
    </select>
    <button onclick="start()">開始</button>
    <button onclick="endSession()">終了</button>
  </p>
  <div id="qText" style="font-size:1.2em; margin:1em 0;">「開始」を押してください</div>
  <div id="aText" style="white-space:pre-line; font-size:1em; color:#444;"></div>
  <div id="subText" style="color:#888;"></div>
  <div id="mcqArea" class="hidden"></div>
  <p>
    <button onclick="markResult(true)">正解</button>
    <button onclick="markResult(false)">不正解</button>
  </p>
  <div id="progress"></div>
</section>

<!-- データ管理 -->
<section id="manage">
  <p>
    <input type="file" id="fileInput" accept=".csv,.json">
    <button onclick="onImportClick()">インポート</button>
    <button onclick="onExportCSV()">CSVエクスポート</button>
    <button onclick="onExportJSON()">JSONエクスポート</button>
    <button onclick="onDeleteSelected()">チェック削除</button>
  </p>
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAll" onclick="onCheckAll(this)"></th>
        <th>コード</th><th>経穴名</th><th>経絡</th><th>読み</th>
        <th>位置</th><th>主治</th><th>その他メモ</th>
        <th>五兪穴</th><th>五行</th><th>編集済</th><th>有効</th><th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div id="info"></div>
</section>

<!-- 説明 -->
<section id="about">
  <p>経穴学習アプリです。CSV/JSONで経穴データを管理できます。<br>
     初期データは seedData に埋め込まれています。</p>
  <button id="btnLoadSeed">サンプルを読み込む（初期化）</button>
</section>

<div id="toast"></div>

<!-- ✅ seedData（ここにJSONを貼る。日本語キーでもOK） -->
<script id="seedData" type="application/json">
[
  {
    "コード": "LU-1",
    "経穴名": "中府",
    "経絡": "手太陰肺経",
    "読み": "ちゅうふ",
    "位置(WHO要約)": "前胸部、第1肋間、前正中線から外方6寸。",
    "主治": "咳嗽、喘息、胸痛、肩背痛。",
    "その他メモ": "サンプル",
    "五兪穴": "",
    "五行": "",
    "編集済": 0,
    "有効": 1
  }
]
</script>

<script>
const STORAGE='keiketsu-mini-v95';
let data=[];

// 保存・読込
const save=()=>localStorage.setItem(STORAGE,JSON.stringify(data));
const load=()=>{try{const raw=localStorage.getItem(STORAGE);if(raw)return JSON.parse(raw)}catch(e){}return null};

// ✅ 日本語キー対応マッピング付き
function mapItem(x){
  return {
    code: x.code || x.コード || '',
    name: x.name || x.経穴名 || '',
    meridian: x.meridian || x.経絡 || '',
    reading: x.reading || x.読み || '',
    location: x.location || x["位置"] || x["位置(WHO要約)"] || '',
    indications: x.indications || x.主治 || '',
    memo: x.memo || x["その他メモ"] || '',
    shu: x.shu || x["五兪穴"] || '',
    phase: x.phase || x.五行 || '',
    edited: x.edited || x.編集済 || 0,
    enabled: (x.enabled!=null?x.enabled:x.有効)!=null ? (x.enabled||x.有効) : 1
  };
}

// 初期化
async function importSeed(){
  try{
    const saved=load();
    if(saved&&saved.length){data=saved;return;}
    const tag=document.getElementById('seedData');
    if(!tag) throw new Error("seedData not found");
    const arr=JSON.parse(tag.textContent);
    data=arr.map(mapItem);
    save();
  }catch(e){
    alert("初期データ読込エラー:"+e.message);
    data=[];
    save();
  }
}

// ===== 以下：学習・管理機能（省略版のまま） =====
// 学習などのJSは既存のものと同じでOK。ここでは割愛します。
// 実際の利用環境では、前回の v9.5 コードの showFront(), showBack(), renderTable() などを再利用してください。

(async function(){
  await importSeed();
})();
</script>
</body>
</html>
