<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Keiketsu Mini v9.5 UIå¼·åŒ–</title>
<meta name="theme-color" content="#0ea5e9"/>
<style>
:root{
  --bg:#f6f8fb; --fg:#0f172a; --muted:#64748b;
  --primary:#0ea5e9; --primary-2:#22c1f1; --accent:#e6f6ff;
  --card:#ffffff; --border:#e5e7eb; --shadow:0 10px 28px rgba(15,23,42,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,"Noto Sans JP",sans-serif}

/* ===== Header & Tabs (v9.5) ===== */
.header{
  background: linear-gradient(135deg,#0ea5e9 0%, #22c1f1 60%, #47d4ff 100%);
  color:#fff; padding:16px 14px 12px;
  position:sticky; top:0; z-index:50; box-shadow:0 6px 18px rgba(14,165,233,.25);
}
.head-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.22);border:1px solid rgba(255,255,255,.38)}
.tag{font-size:11px;padding:2px 6px;border-radius:8px;background:#003e57;color:#bfefff}

.tabs{margin-left:auto;display:flex;gap:10px}
.tab{
  appearance:none;border:0;cursor:pointer;
  background:rgba(255,255,255,.22); color:#fff;
  padding:10px 14px; border-radius:14px; font-weight:700;
  border:1px solid rgba(255,255,255,.35); backdrop-filter: blur(4px);
}
.tab.active{background:#fff;color:#0b1623;border-color:#fff;}

/* ===== Page layout ===== */
main{max-width:1100px;margin:16px auto 28px;padding:0 14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
.section-title{margin:10px 0 10px 4px;display:flex;align-items:center;gap:8px}
.section-title b{font-size:18px}
.small{color:var(--muted);font-size:12px}

/* ===== Controls / Buttons ===== */
.toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
select,input,button,textarea{font-size:14px}
select,input[type=number],input[type=text],input[type=file],textarea{
  padding:9px 10px;border:1px solid var(--border);border-radius:12px;background:#fff
}
.btn{
  padding:10px 14px;border-radius:12px;border:1px solid var(--border);
  background:#fff; cursor:pointer; font-weight:700; transition:.12s;
}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:#1288d6;color:#fff;border-color:#1288d6}
.btn.ok{background:#10b981;color:#fff;border-color:#10b981}
.btn.ng{background:#ef4444;color:#fff;border-color:#ef4444}

/* ===== Study card ===== */
.flash{min-height:280px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:12px;text-align:center}
.q{font-size:24px;font-weight:800}
.a{font-size:16px}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e2fbe8;color:#166534;border:1px solid #bbf7d0;font-size:12px;margin-right:6px}
.pill.alt{background:#e0f2fe;color:#075985;border-color:#bae6fd}
.mcq{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;width:100%;max-width:720px}
.correct{outline:2px solid #10b981}.wrong{outline:2px solid #ef4444}
#toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:999px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:9999}
#toast.show{opacity:.92}

/* ===== Data grid w/ top scroll ===== */
.grid-wrap{position:relative;margin-top:8px}
.hscroll-top,.grid{ scrollbar-gutter: stable both-edges; box-sizing: border-box; }
.hscroll-top{
  height:16px;overflow-x:auto;overflow-y:hidden;border:1px solid var(--border);
  border-bottom:0;border-radius:12px 12px 0 0;background:#fff;padding-bottom:0
}
.hscroll-dummy{height:1px}
.grid{
  border:1px solid var(--border);border-top:0;border-radius:0 0 12px 12px;overflow:auto;max-height:70vh;background:#fff
}
table{width:max(1280px,100%);border-collapse:collapse;font-size:14px;table-layout:fixed}
th,td{border-bottom:1px solid var(--border);padding:9px 8px;text-align:left;vertical-align:top}
th{background:#f3f7fb;position:sticky;top:0;z-index:1}
th.col-code,td[data-key=code]{width:86px}
th.col-name,td[data-key=name]{width:120px}
th.col-meridian,td[data-key=meridian]{width:160px}
th.col-reading,td[data-key=reading]{width:110px}
th.col-loc,td[data-key=location_edit],td[data-key=location_who]{width:380px;white-space:normal;word-break:break-word;overflow-wrap:anywhere}
th.col-ind,td[data-key=indications]{width:300px}
th.col-memo,td[data-key=memo]{width:300px}
th.col-shu,td[data-key=shu]{width:56px}
th.col-phase,td[data-key=phase]{width:56px}
th.col-edited{width:78px;text-align:center}
th.col-enabled{width:72px;text-align:center}

/* Sections */
section{display:none}
section.active{display:block}
</style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="head-inner">
      <div class="brand">
        <h1>Keiketsu Mini</h1>
        <span class="badge">v9.5</span>
        <span class="tag">UIå¼·åŒ–</span>
      </div>
      <div class="tabs">
        <button class="tab active" id="tabStudy" onclick="switchView('viewStudy','tabStudy')">å­¦ç¿’</button>
        <button class="tab" id="tabManage" onclick="switchView('viewManage','tabManage')">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>
        <button class="tab" id="tabAbout" onclick="switchView('viewAbout','tabAbout')">èª¬æ˜</button>
      </div>
    </div>
  </div>

  <main>
    <!-- å­¦ç¿’ -->
    <section id="viewStudy" class="active">
      <div class="section-title">ğŸ“˜ <b>å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³</b> <span class="small">ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼Enterï¼Space ã§è£è¡¨ï¼‰</span></div>
      <div class="card">
        <div class="toolbar">
          <label>å‡ºé¡Œå½¢å¼
            <select id="mode">
              <option value="flash">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</option>
              <option value="mcq">å››æŠã‚¯ã‚¤ã‚º</option>
            </select>
          </label>
          <label>æ–¹å‘
            <select id="qaPreset">
              <option value="name->location" selected>çµŒç©´å â†’ ä½ç½®ï¼ˆç·¨é›†ç‰ˆå„ªå…ˆï¼‰</option>
              <option value="code->name">ã‚³ãƒ¼ãƒ‰ â†’ çµŒç©´å</option>
              <option value="name->indications">çµŒç©´å â†’ ä¸»æ²»</option>
              <option value="code->location">ã‚³ãƒ¼ãƒ‰ â†’ ä½ç½®ï¼ˆç·¨é›†ç‰ˆå„ªå…ˆï¼‰</option>
              <option value="location->name">ä½ç½®ï¼ˆç·¨é›†ç‰ˆå„ªå…ˆï¼‰ â†’ çµŒç©´å</option>
            </select>
          </label>
          <label>é †åº
            <select id="order">
              <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
              <option value="code">ã‚³ãƒ¼ãƒ‰é †</option>
            </select>
          </label>
          <label>çµŒçµ¡
            <select id="filterMeridian"><option value="">ï¼ˆã™ã¹ã¦ï¼‰</option></select>
          </label>
          <label>äº”å…ªç©´
            <select id="filterShu"><option value="">ï¼ˆæŒ‡å®šãªã—ï¼‰</option><option>äº•</option><option>æ»</option><option>å…ª</option><option>çµŒ</option><option>åˆ</option></select>
          </label>
          <label>äº”è¡Œ
            <select id="filterPhase"><option value="">ï¼ˆæŒ‡å®šãªã—ï¼‰</option><option>æœ¨</option><option>ç«</option><option>åœŸ</option><option>é‡‘</option><option>æ°´</option></select>
          </label>
          <label>å‡ºé¡Œæ•° <input id="limit" type="number" value="20" min="5" style="width:86px"> <span class="small"><input type="checkbox" id="chkMax"> æœ€å¤§</span></label>
          <label><input type="checkbox" id="requeueWrong" checked> é–“é•ãˆãŸå•é¡Œã‚’æœ€å¾Œã«å†å‡ºé¡Œ</label>
          <button class="btn primary" onclick="start()">é–‹å§‹</button>
          <button class="btn" onclick="endSession()">çµ‚äº†</button>
          <span id="info" class="small"></span>
        </div>

        <div class="flash" onclick="flashClick()" tabindex="0" aria-label="flashcard">
          <div id="qText" class="q">ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
          <div id="aText" class="a"></div>
          <div id="subText" class="small"></div>
          <div id="mcqArea" class="mcq hidden"></div>
        </div>
        <div class="toolbar" style="justify-content:center;gap:12px;margin-top:8px">
          <button class="btn" onclick="flip()">ç­”ãˆã‚’è¡¨ç¤º/è£è¿”ã™</button>
          <button class="btn ng" onclick="markResult(false)">Ã— ã‚ã‹ã‚‰ãªã„</button>
          <button class="btn ok" onclick="markResult(true)">â—‹ æ­£è§£</button>
        </div>
        <div id="progress" class="small"></div>
      </div>
    </section>

    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
    <section id="viewManage">
      <div class="section-title">ğŸ—‚ï¸ <b>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</b> <span class="small">ï¼ˆä½ç½®ã¯ â€œç·¨é›†ç‰ˆâ€ ã‚’å‡ºé¡Œã«ä½¿ç”¨ã€WHOè¦ç´„ã¯å‚è€ƒï¼‰</span></div>
      <div class="card">
        <div class="toolbar">
          <button class="btn" id="btnAdd">è¡Œã‚’è¿½åŠ </button>
          <button class="btn" id="btnPaste">ä¸€æ‹¬è²¼ã‚Šä»˜ã‘</button>
          <input id="fileInput" type="file" accept=".csv,.CSV,.json,.JSON,text/csv,application/json">
          <button class="btn" id="btnImport" disabled>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="btn" id="btnExportCSV">CSVæ›¸ãå‡ºã—</button>
          <button class="btn" id="btnExportJSON">JSONæ›¸ãå‡ºã—</button>
          <button class="btn ng" id="btnDeleteSelected">é¸æŠã—ãŸè¡Œã‚’å‰Šé™¤</button>
          <input id="txtFind" type="text" placeholder="æ¤œç´¢ï¼ˆã‚³ãƒ¼ãƒ‰/çµŒç©´å/ä½ç½®/ä¸»æ²»/ãƒ¡ãƒ¢/äº”å…ª/äº”è¡Œï¼‰" style="flex:1;min-width:220px">
        </div>

        <div class="grid-wrap">
          <div class="hscroll-top" id="hscrollTop"><div class="hscroll-dummy" id="hscrollDummy"></div></div>
          <div class="grid" id="gridMain">
            <table id="dataTable">
              <thead>
                <tr>
                  <th style="width:30px"><input type="checkbox" id="chkAll"></th>
                  <th class="col-code">ã‚³ãƒ¼ãƒ‰</th>
                  <th class="col-name">çµŒç©´å</th>
                  <th class="col-meridian">çµŒçµ¡</th>
                  <th class="col-reading">èª­ã¿</th>
                  <th class="col-loc">ä½ç½®ï¼ˆç·¨é›†ç‰ˆãƒ»å‡ºé¡Œï¼‰</th>
                  <th class="col-loc">ä½ç½®ï¼ˆWHOè¦ç´„ãƒ»å‚è€ƒï¼‰</th>
                  <th class="col-ind">ä¸»æ²»</th>
                  <th class="col-memo">ãã®ä»–ãƒ¡ãƒ¢</th>
                  <th class="col-shu">äº”å…ªç©´</th>
                  <th class="col-phase">äº”è¡Œ</th>
                  <th class="col-edited">ç·¨é›†æ¸ˆ</th>
                  <th class="col-enabled">æœ‰åŠ¹</th>
                  <th style="width:120px">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
        <div class="small" style="margin-top:6px">â€» ä¸Šã®ãƒãƒ¼ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ï¼ˆãƒšãƒ¼ã‚¸ã®ã©ã“ã‹ã‚‰ã§ã‚‚æ“ä½œå¯ï¼‰ã€‚</div>
      </div>
    </section>

    <!-- èª¬æ˜ -->
    <section id="viewAbout">
      <div class="section-title">â„¹ï¸ <b>èª¬æ˜</b></div>
      <div class="card">
        <ul style="margin:0 0 8px 18px">
          <li>ã€Œä½ç½®ã€ã¯ <b>ç·¨é›†ç‰ˆ</b>ï¼ˆå‡ºé¡Œã«ä½¿ç”¨ï¼‰ã¨ <b>WHOè¦ç´„</b> ã®äºŒå±¤ç®¡ç†ã€‚</li>
          <li>æœ‰åŠ¹/ç„¡åŠ¹ã§å‡ºé¡Œå¯¾è±¡ã‚’åˆ¶å¾¡ã€ç·¨é›†æ¸ˆãƒ•ãƒ©ã‚°ã§æ ¡æ­£é€²æ—ã‚’å¯è¦–åŒ–ã€‚</li>
          <li>CSV/JSONï¼šæ—§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚‚å–ã‚Šè¾¼ã¿äº’æ›ã€‚</li>
          <li>ã‚³ãƒ¼ãƒ‰é †ï¼šCV â†’ GV â†’ LU â†’ LI â†’ ST â†’ SP â†’ HT â†’ SI â†’ BL â†’ KI â†’ PC â†’ SJ â†’ GB â†’ LVã€‚</li>
        </ul>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnResetSeed">ã‚µãƒ³ãƒ—ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆåˆæœŸåŒ–ï¼‰</button>
          <button class="btn" id="btnForceSeed">ã‚µãƒ³ãƒ—ãƒ«10ç©´ã‚’å¼·åˆ¶æŠ•å…¥</button>
        </div>
      </div>
    </section>
  </main>

  <!-- ä¸€æ‹¬è²¼ã‚Šä»˜ã‘ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <dialog id="dlgPaste">
    <h3>ä¸€æ‹¬è²¼ã‚Šä»˜ã‘ï¼ˆCSVæ¨å¥¨ï¼‰</h3>
    <p class="small">æ¨å¥¨ãƒ˜ãƒƒãƒ€ï¼š
    <code>ã‚³ãƒ¼ãƒ‰,çµŒç©´å,çµŒçµ¡,èª­ã¿,ä½ç½®(ç·¨é›†ç‰ˆ),ä½ç½®(WHOè¦ç´„),ä¸»æ²»,ãã®ä»–ãƒ¡ãƒ¢,äº”å…ªç©´,äº”è¡Œ,ç·¨é›†æ¸ˆ,æœ‰åŠ¹</code></p>
    <textarea id="taPaste" rows="12" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:10px"></textarea>
    <div style="margin-top:10px;text-align:right">
      <button class="btn" id="btnPasteCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn primary" id="btnPasteApply">å–ã‚Šè¾¼ã‚€</button>
    </div>
  </dialog>

  <!-- åˆæœŸã‚µãƒ³ãƒ—ãƒ«ï¼ˆ10ç©´ãƒ»WHOè¦ç´„ï¼‰ -->
  <script type="application/json" id="seedData">
  [
    {"code":"CV12","name":"ä¸­è„˜","meridian":"ä»»è„ˆ","reading":"ã¡ã‚…ã†ã‹ã‚“","location_edit":"","location_who":"è‡ã®ä¸Š4å¯¸ã€å‰æ­£ä¸­ç·šä¸Š","indications":"èƒƒç—›ã€æ¶ˆåŒ–ä¸è‰¯ã€å˜”åã€é£Ÿæ¬²ä¸æŒ¯","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"GV14","name":"å¤§æ¤","meridian":"ç£è„ˆ","reading":"ã ã„ã¤ã„","location_edit":"","location_who":"ç¬¬7é šæ¤æ£˜çªèµ·ä¸‹ã€å¾Œæ­£ä¸­ç·šä¸Š","indications":"é¢¨é‚ªã€ç™ºç†±ã€é šè‚©ã®ç—›ã¿","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"LU1","name":"ä¸­åºœ","meridian":"æ‰‹ã®å¤ªé™°è‚ºçµŒ","reading":"ã¡ã‚…ã†ãµ","location_edit":"","location_who":"ç¬¬1è‚‹é–“ã€å‰æ­£ä¸­ç·šã®å¤–æ–¹6å¯¸","indications":"å’³ã€å–˜æ¯ã€èƒ¸ç—›","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"LU5","name":"å°ºæ²¢","meridian":"æ‰‹ã®å¤ªé™°è‚ºçµŒ","reading":"ã—ã‚ƒããŸã","location_edit":"","location_who":"è‚˜çª©æ¨ªç´‹ä¸Šã€ä¸Šè…•äºŒé ­ç­‹è…±ã®æ©ˆå´","indications":"å’³ã€å–˜æ¯ã€å’½å–‰ç—›","memo":"","shu":"åˆ","phase":"æ°´","edited":0,"enabled":1},
    {"code":"LU9","name":"å¤ªæ·µ","meridian":"æ‰‹ã®å¤ªé™°è‚ºçµŒ","reading":"ãŸã„ãˆã‚“","location_edit":"","location_who":"æ‰‹é–¢ç¯€æ¨ªç´‹ä¸Šã€æ©ˆéª¨å‹•è„ˆæ‹å‹•éƒ¨","indications":"å’³ã€èƒ¸ç—›ã€æ‰‹é–¢ç¯€ç—›","memo":"","shu":"å…ª","phase":"åœŸ","edited":0,"enabled":1},
    {"code":"LI4","name":"åˆè°·","meridian":"æ‰‹ã®é™½æ˜å¤§è…¸çµŒ","reading":"ã”ã†ã“ã","location_edit":"","location_who":"ç¬¬1ãƒ»ç¬¬2ä¸­æ‰‹éª¨ã®é–“ã€ç¬¬2ä¸­æ‰‹éª¨ä¸­ç‚¹ã®æ©ˆå´","indications":"é ­ç—›ã€æ­¯ç—›ã€ç™ºç†±","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"LI11","name":"æ›²æ± ","meridian":"æ‰‹ã®é™½æ˜å¤§è…¸çµŒ","reading":"ãã‚‡ãã¡","location_edit":"","location_who":"è‚˜çª©å¤–å´ç«¯","indications":"ç™ºç†±ã€çš®è†šç–¾æ‚£ã€ä¸Šè‚¢ç—›","memo":"","shu":"åˆ","phase":"åœŸ","edited":0,"enabled":1},
    {"code":"ST36","name":"è¶³ä¸‰é‡Œ","meridian":"è¶³ã®é™½æ˜èƒƒçµŒ","reading":"ã‚ã—ã•ã‚“ã‚Š","location_edit":"","location_who":"çŠ¢é¼»ã®ä¸‹3å¯¸ã€è„›éª¨å¤–å´","indications":"èƒƒè…¸ç—‡çŠ¶ã€ç–²åŠ´å›å¾©","memo":"","shu":"åˆ","phase":"åœŸ","edited":0,"enabled":1},
    {"code":"SP6","name":"ä¸‰é™°äº¤","meridian":"è¶³ã®å¤ªé™°è„¾çµŒ","reading":"ã•ã‚“ã„ã‚“ã“ã†","location_edit":"","location_who":"å†…æœå°–ã®ä¸Š3å¯¸ã€è„›éª¨å¾Œç¸","indications":"å©¦äººç§‘ãƒ»æ³Œå°¿å™¨ã®è«¸ç—‡","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"HT7","name":"ç¥é–€","meridian":"æ‰‹ã®å°‘é™°å¿ƒçµŒ","reading":"ã—ã‚“ã‚‚ã‚“","location_edit":"","location_who":"æ‰‹é–¢ç¯€æ¨ªç´‹ä¸Šã€å°ºå´æ‰‹æ ¹å±ˆç­‹è…±ã®æ©ˆå´","indications":"ä¸çœ ã€å‹•æ‚¸ã€ç²¾ç¥å®‰å®š","memo":"","shu":"å…ª","phase":"åœŸ","edited":0,"enabled":1}
  ]
  </script>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
  /* ===== util ===== */
  const el=id=>document.getElementById(id);
  const STORAGE='keiketsu-mini-v95';
  let data=[],filtered=[],toastTimer;
  const YIN=new Set(['æ‰‹ã®å¤ªé™°è‚ºçµŒ','æ‰‹ã®å¥é™°å¿ƒåŒ…çµŒ','æ‰‹ã®å°‘é™°å¿ƒçµŒ','è¶³ã®å¤ªé™°è„¾çµŒ','è¶³ã®å°‘é™°è…çµŒ','è¶³ã®å¥é™°è‚çµŒ']);
  const PHASE_SEQ_YIN=['æœ¨','ç«','åœŸ','é‡‘','æ°´'], PHASE_SEQ_YANG=['é‡‘','æ°´','æœ¨','ç«','åœŸ'];
  const SHU_POINTS={'æ‰‹ã®å¤ªé™°è‚ºçµŒ':{'äº•':'LU11','æ»':'LU10','å…ª':'LU9','çµŒ':'LU8','åˆ':'LU5'},'æ‰‹ã®é™½æ˜å¤§è…¸çµŒ':{'äº•':'LI1','æ»':'LI2','å…ª':'LI3','çµŒ':'LI5','åˆ':'LI11'},'è¶³ã®é™½æ˜èƒƒçµŒ':{'äº•':'ST45','æ»':'ST44','å…ª':'ST43','çµŒ':'ST41','åˆ':'ST36'},'è¶³ã®å¤ªé™°è„¾çµŒ':{'äº•':'SP1','æ»':'SP2','å…ª':'SP3','çµŒ':'SP5','åˆ':'SP9'},'æ‰‹ã®å°‘é™°å¿ƒçµŒ':{'äº•':'HT9','æ»':'HT8','å…ª':'HT7','çµŒ':'HT4','åˆ':'HT3'},'æ‰‹ã®å¤ªé™½å°è…¸çµŒ':{'äº•':'SI1','æ»':'SI2','å…ª':'SI3','çµŒ':'SI5','åˆ':'SI8'},'è¶³ã®å¤ªé™½è†€èƒ±çµŒ':{'äº•':'BL67','æ»':'BL66','å…ª':'BL65','çµŒ':'BL60','åˆ':'BL40'},'è¶³ã®å°‘é™°è…çµŒ':{'äº•':'KI1','æ»':'KI2','å…ª':'KI3','çµŒ':'KI7','åˆ':'KI10'},'æ‰‹ã®å¥é™°å¿ƒåŒ…çµŒ':{'äº•':'PC9','æ»':'PC8','å…ª':'PC7','çµŒ':'PC5','åˆ':'PC3'},'æ‰‹ã®å°‘é™½ä¸‰ç„¦çµŒ':{'äº•':'SJ1','æ»':'SJ2','å…ª':'SJ3','çµŒ':'SJ6','åˆ':'SJ10'},'è¶³ã®å°‘é™½èƒ†çµŒ':{'äº•':'GB44','æ»':'GB43','å…ª':'GB41','çµŒ':'GB38','åˆ':'GB34'},'è¶³ã®å¥é™°è‚çµŒ':{'äº•':'LV1','æ»':'LV2','å…ª':'LV3','çµŒ':'LV4','åˆ':'LV8'}};
  const PREFIX_ORDER=['CV','GV','LU','LI','ST','SP','HT','SI','BL','KI','PC','SJ','GB','LV'];
  const PREFIX_RANK=Object.fromEntries(PREFIX_ORDER.map((p,i)=>[p,i]));
  const truthy=v=>v===true||v===1||v==='1'||v==='true'||v==='TRUE';
  function toast(msg){let t=el('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),1500)}
  function csvEscape(s){if(s==null)s='';s=String(s);return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s}
  function codeParts(code){const s=(code||'').toUpperCase().trim();const m=s.match(/^([A-Z]+)(\d+)$/);if(m)return{prefix:m[1],num:parseInt(m[2],10),raw:s};const m2=s.match(/^([A-Z]+)(\d+)/);if(m2)return{prefix:m2[1],num:parseInt(m2[2],10),raw:s};return{prefix:s,num:Number.MAX_SAFE_INTEGER,raw:s}}
  function prefixRank(p){p=(p||'').toUpperCase();return (p in PREFIX_RANK)?PREFIX_RANK[p]:999}
  function deriveShuPhase(it){const mer=it.meridian||'';const code=(it.code||'').toUpperCase();const m=SHU_POINTS[mer];if(m){const order=['äº•','æ»','å…ª','çµŒ','åˆ'];for(let i=0;i<order.length;i++){const k=order[i];if(m[k]===code){const phase=(YIN.has(mer)?PHASE_SEQ_YIN:PHASE_SEQ_YANG)[i];return{shu:k,phase}}}}return{shu:it.shu||'',phase:it.phase||''}}
  function displayLocation(it){ if(it.location_edit&&it.location_edit.trim()) return it.location_edit.trim(); if(it.location_who&&it.location_who.trim()) return it.location_who.trim(); return (it.location||'').trim(); }
  function ensureDefaults(d){
    if(typeof d.enabled==='undefined') d.enabled=1;
    if(typeof d.edited==='undefined') d.edited=0;
    d.location_who=d.location_who||d['ä½ç½®(WHOè¦ç´„)']||d['ä½ç½®(WHOåŸæ–‡)']||'';
    d.location_edit=d.location_edit||d['ä½ç½®(ç·¨é›†ç‰ˆ)']||'';
    if(!d.location_edit&&d.location) d.location_edit=d.location;
    const sp=deriveShuPhase(d); if(!d.shu)d.shu=sp.shu; if(!d.phase)d.phase=sp.phase;
    return d;
  }

  /* ===== Top scroll sync (GLOBAL) ===== */
  function adjustTop(){
    const grid = document.getElementById('gridMain');
    const top  = document.getElementById('hscrollTop');
    const dum  = document.getElementById('hscrollDummy');
    const tbl  = document.getElementById('dataTable');
    if(!grid || !top || !dum || !tbl) return;
    dum.style.width = (tbl.scrollWidth || 1200) + 'px';
    const sbw = grid.offsetWidth - grid.clientWidth; // vertical scrollbar width
    top.style.paddingRight = sbw > 0 ? (sbw + 'px') : '0px';
  }

  /* ===== Tabs ===== */
  function switchView(viewId,tabId){
    ['viewStudy','viewManage','viewAbout'].forEach(id=>{const s=el(id); if(s) s.classList.remove('active');});
    el(viewId).classList.add('active');
    ['tabStudy','tabManage','tabAbout'].forEach(id=>{const b=el(id); if(b) b.classList.remove('active');});
    el(tabId).classList.add('active');
    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚’è¡¨ç¤ºã—ãŸâ€œå¾Œâ€ã«2ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã£ã¦è¨ˆæ¸¬
    if(viewId==='viewManage'){ requestAnimationFrame(()=>requestAnimationFrame(adjustTop)); }
  }
  window.switchView=switchView;

  /* ===== Study ===== */
  let session={list:[],i:0,mode:'flash',correct:0,wrong:0,showing:false,started:false,qKey:'name',aKey:'location',requeueWrong:true,order:'random'};
  function labelFor(k){return({code:'ã‚³ãƒ¼ãƒ‰',name:'çµŒç©´å',location:'ä½ç½®',indications:'ä¸»æ²»'})[k]||k}
  function applyPreset(){
    const pv={'name->location':{qKey:'name',aKey:'location'},'code->name':{qKey:'code',aKey:'name'},'name->indications':{qKey:'name',aKey:'indications'},'code->location':{qKey:'code',aKey:'location'},'location->name':{qKey:'location',aKey:'name'}};
    const p=pv[el('qaPreset').value]||pv['name->location'];session.qKey=p.qKey;session.aKey=p.aKey
  }
  function clearStudyUI(){el('qText').textContent='ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';el('aText').innerHTML='';el('subText').textContent='';const area=el('mcqArea');area.innerHTML='';area.classList.add('hidden');el('progress').textContent='';session.showing=false}
  function endSession(){session.started=false;session.list=[];session.i=0;session.correct=0;session.wrong=0;clearStudyUI();toast('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸ')}
  function applyPresetAndFilterPool(){
    applyPreset(); session.requeueWrong=el('requeueWrong').checked; session.order=el('order').value;
    const mer=el('filterMeridian').value, shu=el('filterShu').value, ph=el('filterPhase').value;
    let pool=data.filter(x=>x.enabled==null?1:truthy(x.enabled));
    if(mer) pool=pool.filter(x=>(x.meridian||'')===mer);
    if(shu) pool=pool.filter(x=>(x.shu||'')===shu);
    if(ph) pool=pool.filter(x=>(x.phase||'')===ph);
    pool=pool.filter(x=>{
      const qv=(session.qKey==='location')?displayLocation(x):(x[session.qKey]||'');
      const av=(session.aKey==='location')?displayLocation(x):(x[session.aKey]||'');
      return (qv||'').trim() && (av||'').trim();
    });
    if(session.order==='code'){
      pool.sort((a,b)=>{
        // CVâ†’GVâ†’LUâ†’LIâ†’STâ†’SPâ†’HTâ†’SIâ†’BLâ†’KIâ†’PCâ†’SJâ†’GBâ†’LV ã®æ•°å€¤æ˜‡é †
        const ca=(a.code||'').toUpperCase(), cb=(b.code||'').toUpperCase();
        const ma=ca.match(/^([A-Z]+)(\d+)/), mb=cb.match(/^([A-Z]+)(\d+)/);
        const ra = ma ? PREFIX_RANK[ma[1]] ?? 999 : 999;
        const rb = mb ? PREFIX_RANK[mb[1]] ?? 999 : 999;
        if(ra!==rb) return ra-rb;
        const na = ma ? parseInt(ma[2],10) : 1e9;
        const nb = mb ? parseInt(mb[2],10) : 1e9;
        if(na!==nb) return na-nb;
        return ca.localeCompare(cb);
      });
    }else{
      for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]]}
    }
    return pool;
  }
  function start(){
    clearStudyUI();
    session.mode=el('mode').value;
    const pool=applyPresetAndFilterPool();
    const useMax=el('chkMax').checked;
    let limit=parseInt(el('limit').value||'20',10); if(isNaN(limit)||limit<1) limit=20;
    const finalLimit=useMax?pool.length:Math.min(Math.max(5,limit),Math.max(5,pool.length));
    session.list=pool.slice(0,finalLimit);
    session.i=0; session.correct=0; session.wrong=0; session.showing=false; session.started=session.list.length>0;
    if(!session.started){el('qText').textContent='è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';el('aText').textContent='å‡ºé¡Œå½¢å¼ãƒ»çµã‚Šè¾¼ã¿ãƒ»CSVã‚’ã”ç¢ºèªãã ã•ã„';return}
    if(session.mode==='mcq') showMCQ(); else showFront(); updateProgress();
  }
  function current(){return session.list[session.i]}
  function showFront(){
    const it=current(); const qv=(session.qKey==='location')?displayLocation(it):(it[session.qKey]||'â€”');
    el('qText').textContent=labelFor(session.qKey)+'ï¼š'+(qv||'â€”');
    el('aText').innerHTML='';
    el('subText').textContent='ã‚¯ãƒªãƒƒã‚¯ï¼Enterï¼Space ã§è£é¢è¡¨ç¤º';
    el('mcqArea').classList.add('hidden');
    session.showing=false;
  }
  function showBack(){
    const it=current(); const av=(session.aKey==='location')?displayLocation(it):(it[session.aKey]||'â€”');
    const sp=(it.shu&&it.phase)?(`<span class="pill">äº”å…ªï¼š${it.shu}</span><span class="pill">äº”è¡Œï¼š${it.phase}</span>`):'';
    el('qText').textContent=labelFor(session.aKey)+'ï¼š'+(av||'â€”');
    el('aText').innerHTML=
      `<span class="pill alt">${it.code||''}</span><span class="pill alt">${it.meridian||''}</span>${sp}
      <div><b>çµŒç©´åï¼š</b>${it.name||'â€”'}ï¼ˆ${it.reading||''}ï¼‰</div>
      <div><b>ä½ç½®ï¼ˆè¡¨ç¤ºï¼‰ï¼š</b>${displayLocation(it)}</div>
      ${it.location_edit?`<div class="small"><b>ç·¨é›†ç‰ˆï¼š</b>${it.location_edit}</div>`:''}
      ${it.location_who?`<div class="small"><b>WHOè¦ç´„ï¼š</b>${it.location_who}</div>`:''}
      <div><b>ä¸»æ²»ï¼š</b>${it.indications||'â€”'}</div>
      <div><b>ãã®ä»–ï¼š</b>${it.memo||'â€”'}</div>`;
    el('subText').textContent='ã‚‚ã†ä¸€åº¦ã§è¡¨ã¸';
    el('mcqArea').classList.add('hidden');
    session.showing=true;
  }
  function flip(){ if(!session.started||!session.list.length){alert('ã¾ãšã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„');return} if(session.mode==='mcq') return; if(session.showing)showFront(); else showBack(); }
  function updateProgress(){el('progress').textContent=`ç™»éŒ²ï¼š${data.length}ä»¶ / è¡¨ç¤ºï¼š${session.list.length}ä»¶ã€€é€²æ—ï¼š${session.i+1}/${session.list.length}ï¼ˆæ­£ ${session.correct}ãƒ»èª¤ ${session.wrong}ï¼‰`}
  function handleWrongRequeue(it){ if(!el('requeueWrong').checked) return; session.list.push(it) }
  function next(){ session.i++; if(session.i>=session.list.length){ el('qText').textContent='ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼'; el('aText').textContent=`æ­£è§£ ${session.correct} / ä¸æ­£è§£ ${session.wrong}`; el('subText').textContent=''; el('mcqArea').classList.add('hidden'); el('progress').textContent=''; session.started=false; return } if(session.mode==='mcq') showMCQ(); else showFront(); updateProgress(); }
  function markResult(ok){ if(!session.started||!session.list.length){alert('ã¾ãšã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„');return} const it=current(); if(ok){session.correct++;toast('æ­£è§£')}else{session.wrong++;handleWrongRequeue(it);toast('ä¸æ­£è§£')} next(); }
  function flashClick(){ if(!session.started){start()} else if(session.mode==='flash'){flip()} }
  document.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); flashClick(); }});
  function showMCQ(){
    const it=current(); const qv=(session.qKey==='location')?displayLocation(it):(it[session.qKey]||'â€”');
    el('qText').textContent=labelFor(session.qKey)+'ï¼š'+(qv||'â€”'); el('aText').textContent=''; el('subText').textContent='';
    const area=el('mcqArea'); area.innerHTML=''; area.classList.remove('hidden');
    const opts=pickOptions(it,session.aKey);
    opts.forEach(o=>{
      const av=(session.aKey==='location')?displayLocation(o):(o[session.aKey]||'ï¼ˆæœªè¨­å®šï¼‰');
      const btn=document.createElement('button'); btn.className='btn'; btn.type='button'; btn.textContent=av||'ï¼ˆæœªè¨­å®šï¼‰';
      btn.onclick=()=>{ if(btn.dataset.done){ next(); return } if(o===it){ btn.classList.add('correct'); session.correct++; toast('æ­£è§£') } else { btn.classList.add('wrong'); session.wrong++; handleWrongRequeue(it); toast('ä¸æ­£è§£') } btn.dataset.done='1'; setTimeout(next,320); };
      area.appendChild(btn);
    });
  }
  function pickOptions(target,aKey){
    const pool=data.filter(x=>(x.enabled==null?1:truthy(x.enabled)) && (((aKey==='location')?displayLocation(x):(x[aKey]||'')).trim()));
    const uniq=[],seen=new Set();
    for(const x of pool){ const v=(aKey==='location')?displayLocation(x):(x[aKey]||''); if(!seen.has(v)){ uniq.push(x); seen.add(v) } }
    const opts=[target];
    while(opts.length<4&&uniq.length){ const idx=Math.floor(Math.random()*uniq.length); const cand=uniq.splice(idx,1)[0]; const cv=(aKey==='location')?displayLocation(cand):cand[aKey]; const tv=(aKey==='location')?displayLocation(target):target[aKey]; if(cv!==tv) opts.push(cand) }
    while(opts.length<4) opts.push(target);
    for(let i=opts.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[opts[i],opts[j]]=[opts[j],opts[i]]}
    return opts;
  }

  /* ===== Data management ===== */
  function keyOf(d){return d.code||d.name||''}
  function indexByKey(k){return data.findIndex(x=>keyOf(x)===k)}
  function normalizeRow(tr){
    const obj={};
    tr.querySelectorAll('[data-key]').forEach(td=>obj[td.dataset.key]=td.textContent.trim());
    obj.enabled = tr.querySelector('.enabledBox')?.checked ? 1 : 0;
    obj.edited  = tr.querySelector('.editedBox')?.checked ? 1 : 0;
    const sp=deriveShuPhase(obj); if(!obj.shu) obj.shu=sp.shu; if(!obj.phase) obj.phase=sp.phase;
    return obj;
  }
  function applyEdit(tr,oldKey){
    const obj=normalizeRow(tr); const newKey=obj.code||obj.name||'';
    let idx=indexByKey(oldKey); if(idx===-1) idx=indexByKey(newKey);
    if(idx===-1){ data.push(obj) } else { data[idx]=Object.assign({},data[idx],obj) }
    save(); tr.querySelector('.chkRow').dataset.key=newKey
  }
  function onAddClick(){
    let base='NEW',n=1; while(indexByKey(base+n)!==-1)n++;
    data.unshift(ensureDefaults({code:base+n,name:'',meridian:'',reading:'',location_edit:'',location_who:'',indications:'',memo:'',shu:'',phase:'',edited:0,enabled:1}));
    save(); refresh();
  }
  function rowDel(key){ if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return; const i=indexByKey(key); if(i!==-1){ data.splice(i,1); save(); refresh(); toast('å‰Šé™¤ã—ã¾ã—ãŸ') } }
  function rowDup(key){ const i=indexByKey(key); if(i===-1) return; const src=data[i]; let c=(src.code||src.name||'COPY')+'_copy',k=1; while(indexByKey(c)!==-1){ c=(src.code||src.name||'COPY')+'_copy'+(++k) } data.splice(i+1,0,Object.assign({},src,{code:c})); save(); refresh(); toast('è¤‡è£½ã—ã¾ã—ãŸ') }
  function onDeleteSelected(){
    const keys=Array.from(document.querySelectorAll('#tbody .chkRow:checked')).map(c=>c.dataset.key).filter(Boolean);
    if(!keys.length){alert('å‰Šé™¤ã™ã‚‹è¡Œã«ãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ã¦ãã ã•ã„');return}
    if(!confirm(keys.length+' è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const set=new Set(keys);
    data=data.filter(x=>!set.has(x.code||x.name));
    save(); refresh(); toast('é¸æŠã—ãŸè¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }
  function onCheckAll(box){ document.querySelectorAll('#tbody .chkRow').forEach(ch=>ch.checked=box.checked) }

  function renderTable(){
    const q=(el('txtFind')?.value||'').trim().toLowerCase();
    filtered=data.filter(d=>{
      if(!q) return true;
      const s=[d.code||'',d.name||'',d.meridian||'',d.reading||'',d.location_edit||'',d.location_who||'',d.indications||'',d.memo||'',d.shu||'',d.phase||''].join(' ').toLowerCase();
      return s.includes(q);
    });
    const tb=el('tbody'); if(!tb) return; tb.innerHTML='';
    filtered.forEach(d=>{
      const key=d.code||d.name||'';
      const tr=document.createElement('tr');
      tr.innerHTML =
        `<td><input type="checkbox" class="chkRow" data-key="${key}"></td>`+
        `<td contenteditable="true" data-key="code">${d.code||''}</td>`+
        `<td contenteditable="true" data-key="name">${d.name||''}</td>`+
        `<td contenteditable="true" data-key="meridian">${d.meridian||''}</td>`+
        `<td contenteditable="true" data-key="reading">${d.reading||''}</td>`+
        `<td contenteditable="true" data-key="location_edit">${d.location_edit||''}</td>`+
        `<td contenteditable="true" data-key="location_who">${d.location_who||''}</td>`+
        `<td contenteditable="true" data-key="indications">${d.indications||''}</td>`+
        `<td contenteditable="true" data-key="memo">${d.memo||''}</td>`+
        `<td contenteditable="true" data-key="shu">${d.shu||''}</td>`+
        `<td contenteditable="true" data-key="phase">${d.phase||''}</td>`+
        `<td style="text-align:center"><input type="checkbox" class="editedBox" ${truthy(d.edited)?'checked':''}></td>`+
        `<td style="text-align:center"><input type="checkbox" class="enabledBox" ${truthy(d.enabled)?'checked':''}></td>`+
        `<td><button class="btn" onclick="rowDup('${key.replace(/'/g,"\\'")}')">è¤‡è£½</button> `+
        `<button class="btn ng" onclick="rowDel('${key.replace(/'/g,"\\'")}')">å‰Šé™¤</button></td>`;
      tr.addEventListener('blur',ev=>{
        const td=ev.target.closest('td[contenteditable=true]'); if(!td) return;
        const row=td.closest('tr'); const oldKey=row.querySelector('.chkRow')?.dataset.key||'';
        applyEdit(row,oldKey);
      },true);
      tr.querySelector('.enabledBox').addEventListener('change',ev=>{
        const row=ev.target.closest('tr'); const k=row.querySelector('.chkRow')?.dataset.key||key;
        const i=indexByKey(k); if(i!==-1){ data[i].enabled=ev.target.checked?1:0; save(); toast(ev.target.checked?'æœ‰åŠ¹ã«ã—ã¾ã—ãŸ':'ç„¡åŠ¹ã«ã—ã¾ã—ãŸ') }
      });
      tr.querySelector('.editedBox').addEventListener('change',ev=>{
        const row=ev.target.closest('tr'); const k=row.querySelector('.chkRow')?.dataset.key||key;
        const i=indexByKey(k); if(i!==-1){ data[i].edited=ev.target.checked?1:0; save(); toast(ev.target.checked?'ç·¨é›†æ¸ˆã«ã—ã¾ã—ãŸ':'æœªç¢ºèªã«ã—ã¾ã—ãŸ') }
      });
      tb.appendChild(tr);
    });

    const all=el('chkAll'); if(all) all.checked=false;
    el('info').textContent=`ç™»éŒ²ï¼š${data.length}ä»¶ / è¡¨ç¤ºï¼š${filtered.length}ä»¶ï¼ˆç„¡åŠ¹ã¯å‡ºé¡Œé™¤å¤–ãƒ»ä½ç½®ã¯ç·¨é›†ç‰ˆå„ªå…ˆï¼‰`;

    // ä¸Šéƒ¨æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å¹…åŒæœŸ
    adjustTop();
  }

  /* ===== Export ===== */
  function onExportCSV(){
    const headers=['ã‚³ãƒ¼ãƒ‰','çµŒç©´å','çµŒçµ¡','èª­ã¿','ä½ç½®(ç·¨é›†ç‰ˆ)','ä½ç½®(WHOè¦ç´„)','ä¸»æ²»','ãã®ä»–ãƒ¡ãƒ¢','äº”å…ªç©´','äº”è¡Œ','ç·¨é›†æ¸ˆ','æœ‰åŠ¹'];
    const lines=[headers.join(',')];
    for(const d of data){
      const row=[d.code||'',d.name||'',d.meridian||'',d.reading||'',d.location_edit||'',d.location_who||'',d.indications||'',d.memo||'',d.shu||'',d.phase||'',(truthy(d.edited)?1:0),(truthy(d.enabled)?1:0)].map(csvEscape).join(',');
      lines.push(row);
    }
    const blob=new Blob(['\ufeff'+lines.join('\n')],{type:'text/csv'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='keiketsu_v95.csv'; a.click(); URL.revokeObjectURL(url);
    toast('CSVã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
  }
  function onExportJSON(){
    const arr=data.map(d=>({'ã‚³ãƒ¼ãƒ‰':d.code||'','çµŒç©´å':d.name||'','çµŒçµ¡':d.meridian||'','èª­ã¿':d.reading||'','ä½ç½®(ç·¨é›†ç‰ˆ)':d.location_edit||'','ä½ç½®(WHOè¦ç´„)':d.location_who||'','ä¸»æ²»':d.indications||'','ãã®ä»–ãƒ¡ãƒ¢':d.memo||'','äº”å…ªç©´':d.shu||'','äº”è¡Œ':d.phase||'','ç·¨é›†æ¸ˆ':truthy(d.edited)?1:0,'æœ‰åŠ¹':truthy(d.enabled)?1:0}));
    const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='keiketsu_v95.json'; a.click(); URL.revokeObjectURL(url);
    toast('JSONã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
  }

  /* ===== Import / Paste ===== */
  function normalizeHeaders(headers){
    const norm = s => s.replace(/\s+/g,'').replace(/[ï¼‰\)]/g,')');
    const map={}; headers.forEach((h,i)=>map[norm(h)]=i);
    return {get:(k)=>{k=norm(k); return (k in map)?map[k]:-1}};
  }
  function take(r,headers,keyList){ for(const k of keyList){ const i=headers.get(k); if(i>=0) return r[i] } return '' }
  function fixMisMapped(){
    let moved=0;
    for(const d of data){
      if((d.shu||'').length>2 && !(d.indications||'').trim()){ d.indications=d.shu; d.shu=''; moved++; }
      const validPhase=new Set(['æœ¨','ç«','åœŸ','é‡‘','æ°´','']); 
      if(!validPhase.has(d.phase||'') && !(d.indications||'').trim()){ d.indications=d.phase; d.phase=''; moved++; }
    }
    if(moved) toast(`è‡ªå‹•ä¿®å¾©ï¼šä¸»æ²»ã¸ ${moved} ä»¶ç§»å‹•`);
  }
  async function importFromFile(file){
    const buf=await file.arrayBuffer();
    const text=new TextDecoder('utf-8',{fatal:false}).decode(buf);
    let arr=[];
    try{
      if(file.name.endsWith('.json')){
        const j=JSON.parse(text);
        arr=j.map(x=>ensureDefaults({
          code:x.id||x.code||x['ã‚³ãƒ¼ãƒ‰']||'',
          name:x['çµŒç©´å']||x.name||'',
          meridian:x['çµŒçµ¡']||x.meridian||'',
          reading:x['èª­ã¿']||x.reading||x['çµŒç©´å_èª­ã¿']||'',
          location_edit:x['ä½ç½®(ç·¨é›†ç‰ˆ)']||x.location_edit||x['ä½ç½®']||'',
          location_who:x['ä½ç½®(WHOè¦ç´„)']||x['ä½ç½®(WHOåŸæ–‡)']||x.location_who||'',
          indications:x['ä¸»æ²»']||x.indications||x['ä¸»æ²»ãƒ¡ãƒ¢']||'',
          memo:x['ãã®ä»–ãƒ¡ãƒ¢']||x.memo||'',
          shu:x['äº”å…ªç©´']||x.shu||'',
          phase:x['äº”è¡Œ']||x.phase||'',
          edited:x['ç·¨é›†æ¸ˆ']||x.edited||0,
          enabled:x['æœ‰åŠ¹']||x.enabled||1
        }));
      }else{
        const rows=text.replace(/ï¼Œ/g,',').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0);
        const rawHeaders=rows.shift().split(',').map(s=>s.trim());
        const H=normalizeHeaders(rawHeaders);
        for(const line of rows){
          const r=line.split(',');
          const o={
            code:          take(r,H,['ã‚³ãƒ¼ãƒ‰']),
            name:          take(r,H,['çµŒç©´å','name']),
            meridian:      take(r,H,['çµŒçµ¡','meridian']),
            reading:       take(r,H,['èª­ã¿','çµŒç©´å_èª­ã¿','reading']),
            location_edit: take(r,H,['ä½ç½®(ç·¨é›†ç‰ˆ)','ä½ç½®','éƒ¨ä½ãƒ¡ãƒ¢']),
            location_who:  take(r,H,['ä½ç½®(WHOè¦ç´„)','ä½ç½®(WHOåŸæ–‡)']),
            indications:   take(r,H,['ä¸»æ²»','ä¸»æ²»ãƒ¡ãƒ¢','indications']),
            memo:          take(r,H,['ãã®ä»–ãƒ¡ãƒ¢','memo']),
            shu:           take(r,H,['äº”å…ªç©´','shu']),
            phase:         take(r,H,['äº”è¡Œ','phase']),
            edited:        take(r,H,['ç·¨é›†æ¸ˆ'])||0,
            enabled:       take(r,H,['æœ‰åŠ¹'])||1
          };
          arr.push(ensureDefaults(o));
        }
      }
    }catch(e){
      alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ï¼š'+e.message);
      return;
    }
    const mp=new Map(data.map(x=>[x.code||x.name,x])); let add=0,upd=0;
    for(const it of arr){ const key=it.code||it.name; if(!key) continue; if(mp.has(key)){ mp.set(key,Object.assign({},mp.get(key),it)); upd++; } else { mp.set(key,it); add++; } }
    data=Array.from(mp.values());
    fixMisMapped();
    save(); refresh();
    toast(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼šè¿½åŠ  ${add}ãƒ»æ›´æ–° ${upd}ãƒ»å…¨ ${data.length}`);
  }
  function importFromText(text){
    const lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0);
    if(!lines.length) return 0;
    const headerLine = lines[0].includes(',')?lines.shift():'ã‚³ãƒ¼ãƒ‰,çµŒç©´å,çµŒçµ¡,èª­ã¿,ä½ç½®(ç·¨é›†ç‰ˆ),ä½ç½®(WHOè¦ç´„),ä¸»æ²»,ãã®ä»–ãƒ¡ãƒ¢,äº”å…ªç©´,äº”è¡Œ,ç·¨é›†æ¸ˆ,æœ‰åŠ¹';
    const rawHeaders=headerLine.split(',').map(s=>s.trim());
    const H=normalizeHeaders(rawHeaders);
    let count=0;
    const mp=new Map(data.map(x=>[x.code||x.name,x]));
    for(const line of lines){
      const r=line.split(',');
      const o={
        code:          take(r,H,['ã‚³ãƒ¼ãƒ‰']),
        name:          take(r,H,['çµŒç©´å','name']),
        meridian:      take(r,H,['çµŒçµ¡','meridian']),
        reading:       take(r,H,['èª­ã¿','çµŒç©´å_èª­ã¿','reading']),
        location_edit: take(r,H,['ä½ç½®(ç·¨é›†ç‰ˆ)','ä½ç½®','éƒ¨ä½ãƒ¡ãƒ¢']),
        location_who:  take(r,H,['ä½ç½®(WHOè¦ç´„)','ä½ç½®(WHOåŸæ–‡)']),
        indications:   take(r,H,['ä¸»æ²»','ä¸»æ²»ãƒ¡ãƒ¢','indications']),
        memo:          take(r,H,['ãã®ä»–ãƒ¡ãƒ¢','memo']),
        shu:           take(r,H,['äº”å…ªç©´','shu']),
        phase:         take(r,H,['äº”è¡Œ','phase']),
        edited:        take(r,H,['ç·¨é›†æ¸ˆ'])||0,
        enabled:       take(r,H,['æœ‰åŠ¹'])||1
      };
      const key=o.code||o.name; if(!key) continue;
      mp.set(key,Object.assign({},mp.get(key)||{},ensureDefaults(o))); count++;
    }
    data=Array.from(mp.values());
    fixMisMapped();
    save(); refresh();
    return count;
  }

  /* ===== Seed / init ===== */
  function save(){localStorage.setItem(STORAGE,JSON.stringify(data))}
  function load(){try{const raw=localStorage.getItem(STORAGE);if(raw){const arr=JSON.parse(raw);if(Array.isArray(arr))return arr}}catch(e){}return null}
  async function importSeed(){
    try{
      const saved=load();
      if(saved&&saved.length){ data=saved.map(ensureDefaults); return }
      const tag=el('seedData'); if(!tag) throw new Error('seedData ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const arr=JSON.parse(tag.textContent); data=arr.map(ensureDefaults); save();
    }catch(e){ alert('åˆæœŸãƒ‡ãƒ¼ã‚¿èª­è¾¼ã«å¤±æ•—ï¼š'+e.message); data=[]; save(); }
  }
  function resetToSeed(){ try{ localStorage.removeItem(STORAGE) }catch(e){} location.reload() }
  function forceSeed(){
    try{ const arr=JSON.parse(el('seedData').textContent); data=arr.map(ensureDefaults); }
    catch(_){
      data=[
        {"code":"CV12","name":"ä¸­è„˜","meridian":"ä»»è„ˆ","reading":"ã¡ã‚…ã†ã‹ã‚“","location_edit":"","location_who":"è‡ã®ä¸Š4å¯¸ã€å‰æ­£ä¸­ç·šä¸Š","indications":"èƒƒç—›ã€æ¶ˆåŒ–ä¸è‰¯ã€å˜”åã€é£Ÿæ¬²ä¸æŒ¯","memo":"","shu":"","phase":"","edited":0,"enabled":1},
        {"code":"GV14","name":"å¤§æ¤","meridian":"ç£è„ˆ","reading":"ã ã„ã¤ã„","location_edit":"","location_who":"ç¬¬7é šæ¤æ£˜çªèµ·ä¸‹ã€å¾Œæ­£ä¸­ç·šä¸Š","indications":"é¢¨é‚ªã€ç™ºç†±ã€é šè‚©ã®ç—›ã¿","memo":"","shu":"","phase":"","edited":0,"enabled":1},
        {"code":"LU1","name":"ä¸­åºœ","meridian":"æ‰‹ã®å¤ªé™°è‚ºçµŒ","reading":"ã¡ã‚…ã†ãµ","location_edit":"","location_who":"ç¬¬1è‚‹é–“ã€å‰æ­£ä¸­ç·šã®å¤–æ–¹6å¯¸","indications":"å’³ã€å–˜æ¯ã€èƒ¸ç—›","memo":"","shu":"","phase":"","edited":0,"enabled":1}
      ];
    }
    save(); refresh(); toast('ã‚µãƒ³ãƒ—ãƒ«10ç©´ã‚’æŠ•å…¥ã—ã¾ã—ãŸ');
  }

  async function init(){
    await importSeed(); 
    refresh();

    // top scroll sync: åŒæ–¹å‘åŒæœŸã¨è‡ªå‹•è¿½å¾“
    const topBar=el('hscrollTop'), grid=el('gridMain');
    const sync=(from,to)=>from.addEventListener('scroll',()=>{ to.scrollLeft=from.scrollLeft }, {passive:true});
    if(topBar && grid){ sync(topBar,grid); sync(grid,topBar); }

    function callAdjust(){ adjustTop(); }
    window.addEventListener('resize', callAdjust);

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰åŒ–ç›£è¦–
    const tbl=el('dataTable'), tbody=el('tbody');
    if(window.ResizeObserver && grid && tbl){
      const ro=new ResizeObserver(()=>adjustTop()); ro.observe(grid); ro.observe(tbl);
    }
    if(window.MutationObserver && tbody){
      const mo=new MutationObserver(()=>adjustTop()); mo.observe(tbody,{childList:true,subtree:false});
    }
    // åˆæœŸè¡¨ç¤ºã®ä¿é™º
    setTimeout(adjustTop,0); setTimeout(adjustTop,200); setTimeout(adjustTop,600);

    // bind buttons
    el('btnAdd')?.addEventListener('click', onAddClick);
    el('btnPaste')?.addEventListener('click', onBulkPasteOpen);
    el('btnExportCSV')?.addEventListener('click', onExportCSV);
    el('btnExportJSON')?.addEventListener('click', onExportJSON);
    el('btnDeleteSelected')?.addEventListener('click', e=>{e.preventDefault();onDeleteSelected();});
    el('txtFind')?.addEventListener('input', renderTable);
    el('chkAll')?.addEventListener('change', e=>onCheckAll(e.target));

    const fi=el('fileInput'), importBtn=el('btnImport');
    if(fi && importBtn){
      fi.addEventListener('change', ()=>{ importBtn.disabled = !(fi.files && fi.files.length); });
      importBtn.addEventListener('click', async ()=>{
        if(!fi.files || !fi.files.length){ alert('CSV/JSONã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        const f=fi.files[0];
        const okExt=/\.(csv|json)$/i.test(f.name);
        const okType=['text/csv','application/json','application/vnd.ms-excel'].includes(f.type)||f.type==='';
        if(!(okExt||okType)){ if(!confirm('CSV/JSONä»¥å¤–ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return; }
        await importFromFile(f); fi.value=''; importBtn.disabled=true;
      });
    }
    el('btnResetSeed')?.addEventListener('click',e=>{e.preventDefault();resetToSeed()});
    el('btnForceSeed')?.addEventListener('click',e=>{e.preventDefault();forceSeed()});
  }
  function refresh(){
    data=data.map(ensureDefaults);
    const mer=Array.from(new Set(data.map(d=>d.meridian).filter(Boolean))).sort();
    el('filterMeridian').innerHTML='<option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>'+mer.map(m=>`<option>${m}</option>`).join('');
    renderTable();
  }
  init();

  // paste dialog
  function onBulkPasteOpen(){ el('dlgPaste').showModal?el('dlgPaste').showModal():el('dlgPaste').setAttribute('open','') }
  function onPasteCancel(){ el('dlgPaste').close?el('dlgPaste').close():el('dlgPaste').removeAttribute('open') }
  function onPasteApply(){ const txt=el('taPaste').value||''; const n=importFromText(txt); onPasteCancel(); toast(`å–ã‚Šè¾¼ã¿ ${n} ä»¶`) }

  // expose
  window.start=start; window.endSession=endSession; window.flip=flip; window.markResult=markResult; window.flashClick=flashClick;
  window.onAddClick=onAddClick; window.onExportCSV=onExportCSV; window.onExportJSON=onExportJSON;
  window.onBulkPasteOpen=onBulkPasteOpen; window.onPasteCancel=onPasteCancel; window.onPasteApply=onPasteApply;
  window.onDeleteSelected=onDeleteSelected; window.onCheckAll=onCheckAll; window.rowDel=rowDel; window.rowDup=rowDup;
  window.resetToSeed=resetToSeed; window.forceSeed=forceSeed;
  </script>
</body>
</html>
