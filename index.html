<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>経穴学習アプリ v9.6</title>
<style>
body { font-family: sans-serif; margin: 0; padding: 0; }
header { background: #006699; color: white; padding: 0.5em; text-align: center; }
nav { background: #eee; padding: 0.5em; text-align: center; }
nav button { margin: 0 0.2em; }
section { display: none; padding: 1em; }
section.active { display: block; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 2px 4px; }
th { background: #f0f0f0; }
textarea { width: 100%; height: 8em; }
#toast { position: fixed; bottom: 1em; left: 50%; transform: translateX(-50%);
  background: #333; color: #fff; padding: 0.5em 1em; border-radius: 5px;
  opacity: 0; transition: opacity 0.5s; }
#toast.show { opacity: 1; }
</style>
</head>
<body>
<header><h1>経穴学習アプリ v9.6</h1></header>
<nav>
  <button onclick="show('study')">学習</button>
  <button onclick="show('manage')">データ管理</button>
  <button onclick="show('about')">説明</button>
</nav>

<section id="study" class="active">
  <h2>学習モード</h2>
  <div>
    出題形式:
    <select id="qaPreset">
      <option value="name->location">経穴名 → 位置</option>
      <option value="code->name">コード → 経穴名</option>
      <option value="name->indications">経穴名 → 主治</option>
      <option value="location->name">位置 → 経穴名</option>
    </select>
    出題順序:
    <select id="order">
      <option value="random">ランダム</option>
      <option value="code">コード順</option>
    </select>
    出題数:<input id="limit" type="number" value="20" style="width:4em">
    <label><input type="checkbox" id="chkMax">最大</label>
    <label><input type="checkbox" id="requeueWrong" checked>間違え再出題</label>
    <br>
    出題形式:<select id="mode">
      <option value="flash">フラッシュカード</option>
      <option value="mcq">四択クイズ</option>
    </select>
    <button onclick="start()">開始</button>
    <button onclick="endSession()">終了</button>
  </div>
  <hr>
  <div id="qText">「開始」を押してください</div>
  <div id="aText"></div>
  <div id="subText"></div>
  <div id="mcqArea" class="hidden"></div>
  <div id="progress"></div>
  <div>
    <button onclick="flashClick()">裏表</button>
    <button onclick="markResult(true)">正解</button>
    <button onclick="markResult(false)">不正解</button>
  </div>
</section>

<section id="manage">
  <h2>データ管理</h2>
  <div>
    <input type="file" id="fileInput">
    <button onclick="onImportClick()">インポート</button>
    <button onclick="onExportCSV()">CSVエクスポート</button>
    <button onclick="onExportJSON()">JSONエクスポート</button>
    <button onclick="onAddClick()">行追加</button>
    <button onclick="onDeleteSelected()">チェック削除</button>
    <button onclick="importSeed()">サンプル読み込み（初期化）</button>
    <br>
    検索:<input id="txtFind" oninput="refresh()">
    <span id="info"></span>
  </div>
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAll" onclick="onCheckAll(this)"></th>
        <th>コード</th><th>経穴名</th><th>経絡</th><th>読み</th>
        <th>位置(編集版)</th><th>位置(WHO要約)</th>
        <th>主治</th><th>その他メモ</th>
        <th>五兪穴</th><th>五行</th><th>編集済</th><th>有効</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</section>

<section id="about">
  <h2>説明</h2>
  <p>経穴暗記用のフラッシュカード＋四択クイズ＋データ管理ができます。</p>
</section>

<div id="toast"></div>

<!-- 初期データ（サンプル10穴） -->
<script type="application/json" id="seedData">
[
  {"コード":"LU-1","経穴名":"中府","経絡":"手太陰肺経","読み":"ちゅうふ","位置(編集版)":"","位置(WHO要約)":"鎖骨下窩にあり","主治":"咳、喘息","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1},
  {"コード":"LU-2","経穴名":"雲門","経絡":"手太陰肺経","読み":"うんもん","位置(編集版)":"","位置(WHO要約)":"鎖骨下窩外方","主治":"咳、肩痛","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1}
]
</script>

<script>
// ====== 共通ユーティリティ ======
const el = id=>document.getElementById(id);
const STORAGE='keiketsu-mini-v96';
let data=[];

// トースト
let toastTimer;
function toast(msg){
  let t=el('toast');
  t.textContent=msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),1500);
}

// 表示切替
function show(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  el(id).classList.add('active');
}

// ===== データ保存・読込 =====
const save=()=>localStorage.setItem(STORAGE,JSON.stringify(data));
const load=()=>{try{const raw=localStorage.getItem(STORAGE);if(raw)return JSON.parse(raw);}catch(e){}return null;};

// ===== CSV/JSON 安全インポート =====
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
  text=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const rows=[];let i=0,field='',row=[],inQuotes=false;
  while(i<text.length){
    const ch=text[i];
    if(inQuotes){
      if(ch==='"'){if(text[i+1]==='"'){field+='"';i+=2;continue;}inQuotes=false;i++;continue;}
      else{field+=ch;i++;continue;}
    }else{
      if(ch==='"'){inQuotes=true;i++;continue;}
      if(ch===','){row.push(field);field='';i++;continue;}
      if(ch==='\n'){row.push(field);rows.push(row);field='';row=[];i++;continue;}
      field+=ch;i++;continue;
    }
  }
  row.push(field);rows.push(row);
  return rows.filter(r=>r.some(c=>String(c).trim()!==''));
}

function normalizeHeader(s){return String(s).replace(/\uFEFF/g,'').replace(/\s+/g,'').toLowerCase();}
function headerIndexMap(headers){const m={};headers.forEach((h,i)=>m[normalizeHeader(h)]=i);return m;}

function mapRow(row,hmap){
  const pick=keys=>{
    for(const k of keys){const ix=hmap[normalizeHeader(k)];if(ix!=null&&ix<row.length)return (row[ix]??'').trim();}
    return '';
  };
  return {
    code:pick(['コード','code','id']),
    name:pick(['経穴名','name']),
    meridian:pick(['経絡','meridian']),
    reading:pick(['読み','reading']),
    locationEdit:pick(['位置(編集版)','locedit']),
    locationWHO:pick(['位置(who要約)','位置(WHO要約)','locwho']),
    location:pick(['位置(編集版)','位置(who要約)','位置','location']),
    indications:pick(['主治','indications']),
    memo:pick(['その他メモ','memo']),
    shu:pick(['五兪穴','shu']),
    phase:pick(['五行','phase']),
    edited:Number(pick(['編集済','edited'])||0)?1:0,
    enabled:Number(pick(['有効','enabled'])||1)?1:0
  };
}

async function importFromFile(file){
  try{
    const buf=await file.arrayBuffer();
    let text=new TextDecoder('utf-8',{fatal:false}).decode(buf);
    if(file.name.toLowerCase().endsWith('.json')){
      const arr=JSON.parse(text);
      mergeData(arr.map(o=>mapRow(Object.values(o),headerIndexMap(Object.keys(o)))));
      toast(`インポート：${arr.length}件(JSON)`);
      return;
    }
    const table=parseCSV(text);
    const headers=table[0];const hmap=headerIndexMap(headers);
    const arr=[];
    for(let r=1;r<table.length;r++){arr.push(mapRow(table[r],hmap));}
    mergeData(arr);
    toast(`インポート：${arr.length}件(CSV)`);
  }catch(e){alert('インポート失敗: '+e.message);}
}

function importFromText(text){
  try{
    const table=parseCSV(text);
    const headers=table[0];const hmap=headerIndexMap(headers);
    const arr=[];
    for(let r=1;r<table.length;r++){arr.push(mapRow(table[r],hmap));}
    mergeData(arr);
    return arr.length;
  }catch(e){alert('貼付インポート失敗: '+e.message);return 0;}
}

function mergeData(newArr){
  const mp=new Map(data.map(x=>[(x.code||x.name).trim(),x]));
  let add=0,upd=0;
  for(const it of newArr){
    const key=(it.code||it.name).trim();if(!key)continue;
    if(mp.has(key)){mp.set(key,Object.assign({},mp.get(key),it));upd++;}
    else{mp.set(key,it);add++;}
  }
  data=Array.from(mp.values());
  save();refresh();
  console.log(`mergeData: add ${add}, upd ${upd}, total ${data.length}`);
}

// ===== データ管理 =====
function renderTable(){
  const q=(el('txtFind').value||'').trim().toLowerCase();
  const tb=el('tbody');tb.innerHTML='';
  const filtered=data.filter(d=>{
    const s=[d.code,d.name,d.meridian,d.reading,d.location,d.indications,d.memo].join(' ').toLowerCase();
    return !q||s.includes(q);
  });
  filtered.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" class="chkRow" data-key="${d.code||d.name}"></td>
      <td contenteditable>${d.code||''}</td>
      <td contenteditable>${d.name||''}</td>
      <td contenteditable>${d.meridian||''}</td>
      <td contenteditable>${d.reading||''}</td>
      <td contenteditable>${d.locationEdit||''}</td>
      <td contenteditable>${d.locationWHO||''}</td>
      <td contenteditable>${d.indications||''}</td>
      <td contenteditable>${d.memo||''}</td>
      <td contenteditable>${d.shu||''}</td>
      <td contenteditable>${d.phase||''}</td>
      <td contenteditable>${d.edited||0}</td>
      <td contenteditable>${d.enabled||1}</td>
      <td><button onclick="rowDup('${d.code}')">複製</button></td>`;
    tb.appendChild(tr);
  });
  el('info').textContent=`登録:${data.length}件 表示:${filtered.length}件`;
}
function refresh(){renderTable();}
function onCheckAll(box){document.querySelectorAll('.chkRow').forEach(ch=>ch.checked=box.checked);}
function onAddClick(){data.unshift({code:'NEW',name:'',meridian:'',reading:'',locationEdit:'',locationWHO:'',indications:'',memo:'',shu:'',phase:'',edited:0,enabled:1});save();refresh();}
function onDeleteSelected(){
  const keys=Array.from(document.querySelectorAll('.chkRow:checked')).map(c=>c.dataset.key);
  if(!keys.length){alert('削除する行にチェックしてください');return;}
  if(!confirm(keys.length+'行を削除しますか?'))return;
  data=data.filter(x=>!keys.includes(x.code||x.name));save();refresh();toast('削除しました');
}
function onExportCSV(){
  const headers=['コード','経穴名','経絡','読み','位置(編集版)','位置(WHO要約)','主治','その他メモ','五兪穴','五行','編集済','有効'];
  const lines=[headers.join(',')];
  data.forEach(d=>{
    lines.push(headers.map(h=>d[h]||d[normalizeHeader(h)]||'').join(','));
  });
  const blob=new Blob(['\ufeff'+lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='keiketsu.csv';a.click();URL.revokeObjectURL(url);
}
function onExportJSON(){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='keiketsu.json';a.click();URL.revokeObjectURL(url);
}
async function onImportClick(){
  const fi=el('fileInput');if(!fi.files.length){alert('CSV/JSONを選択してください');return;}
  await importFromFile(fi.files[0]);fi.value='';
}
async function importSeed(){
  const saved=load();if(saved){data=saved;refresh();return;}
  const arr=JSON.parse(el('seedData').textContent);
  data=arr;save();refresh();
}

// ===== 学習モード（簡易） =====
let session={list:[],i:0,qKey:'name',aKey:'location',mode:'flash',started:false};
const PRESETS={'code->name':{qKey:'code',aKey:'name'},'name->location':{qKey:'name',aKey:'location'},'name->indications':{qKey:'name',aKey:'indications'},'location->name':{qKey:'location',aKey:'name'}};
function applyPreset(){const p=PRESETS[el('qaPreset').value];session.qKey=p.qKey;session.aKey=p.aKey;}
function start(){applyPreset();session.mode=el('mode').value;session.list=data.slice();session.i=0;session.started=true;showFront();}
function endSession(){session.started=false;el('qText').textContent='終了';}
function current(){return session.list[session.i];}
function showFront(){const it=current();if(!it){el('qText').textContent='データなし';return;}el('qText').textContent=`${it[session.qKey]}`;el('aText').textContent='';}
function showBack(){const it=current();el('aText').textContent=`${it[session.aKey]}`;}
function flip(){if(!session.started)return;if(el('aText').textContent)showFront();else showBack();}
function flashClick(){flip();}
function markResult(ok){session.i++;if(session.i>=session.list.length){el('qText').textContent='完了';session.started=false;}else showFront();}
</script>
</body>
</html>
