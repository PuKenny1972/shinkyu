<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>経穴学習アプリ v9.7.0</title>
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --accent:#0d6efd; --muted:#6b7280; --line:#e5e7eb;
    --ans:#0b7ad1;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:#111}
  header{background:linear-gradient(90deg,#0d6efd,#0aa1ff);color:#fff;padding:12px 16px}
  header h1{margin:0;font-size:18px;font-weight:600}
  nav{background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
  .tabs{display:flex;gap:8px;padding:8px 12px}
  .tabs button{appearance:none;border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .tabs button.active{border-color:var(--accent);color:var(--accent);font-weight:600}
  main{max-width:1200px;margin:16px auto;padding:0 12px}
  section.card{display:none;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  section.card.active{display:block}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .row > *{margin:2px 0}
  select,input[type=number],input[type=text]{padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.ghost{background:#fff}
  .muted{color:var(--muted);font-size:12px}
  hr{border:none;border-top:1px solid var(--line);margin:12px 0}

  /* 学習表示 */
  #display{padding:8px;border-radius:8px}
  #qText{font-size:20px;font-weight:700;margin:8px 0}
  #aText{font-size:16px;margin:8px 0;white-space:pre-wrap}
  #subText{color:var(--muted);font-size:12px}
  #mcqArea.hidden{display:none}
  #mcqArea .btn{min-width:220px}
  .ans-strong{font-weight:800;font-size:18px;color:var(--ans)}

  /* テーブル */
  .tableWrap{width:100%;overflow:auto;border:1px solid var(--line);border-radius:10px}
  table{border-collapse:collapse;width:100%;min-width:1200px;background:#fff}
  th,td{border-bottom:1px solid var(--line);padding:6px 8px;vertical-align:top}
  th{position:sticky;top:0;background:#f9fafb;font-weight:600}
  td[contenteditable]{background:#fffef6}
  td .mini{font-size:11px;color:var(--muted)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
  .toolbar input[type=file]{max-width:240px}
  #toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:.25s}
  #toast.show{opacity:1}
</style>
</head>
<body>
<header><h1>経穴学習アプリ v9.7.0</h1></header>

<nav>
  <div class="tabs">
    <button class="active" data-tab="study" onclick="show('study',this)">学習</button>
    <button data-tab="manage" onclick="show('manage',this)">データ管理</button>
    <button data-tab="about" onclick="show('about',this)">説明</button>
  </div>
</nav>

<main>
  <!-- 学習 -->
  <section id="study" class="card active">
    <div class="row">
      <label>出題形式:
        <select id="qaPreset">
          <option value="name->location" selected>経穴名 → 位置</option>
          <option value="code->name">コード → 経穴名</option>
          <option value="name->indications">経穴名 → 主治</option>
          <option value="location->name">位置 → 経穴名</option>
        </select>
      </label>
      <label>出題順序:
        <select id="order">
          <option value="random">ランダム</option>
          <option value="code">コード順</option>
        </select>
      </label>
      <label>出題数:<input id="limit" type="number" value="20" style="width:5em"></label>
      <label><input type="checkbox" id="chkMax">最大</label>
      <label><input type="checkbox" id="requeueWrong" checked>間違え再出題</label>
      <label>形式:
        <select id="mode">
          <option value="flash">フラッシュカード</option>
          <option value="mcq">四択クイズ</option>
        </select>
      </label>
      <button class="btn primary" onclick="start()">開始</button>
      <button class="btn ghost" onclick="endSession()">終了</button>
      <span id="progress" class="muted"></span>
    </div>
    <hr>
    <div id="display">
      <div id="qText">「開始」を押してください</div>
      <div id="aText"></div>
      <div id="subText" class="muted">クリック＝再生/停止　／　ダブルクリック or Enter＝一括表示　／　Space＝再生/停止</div>
    </div>
    <div id="mcqArea" class="hidden row"></div>
    <div class="row">
      <button class="btn" onclick="showBoth()">裏表</button>
      <button class="btn" onclick="markResult(true)">正解</button>
      <button class="btn" onclick="markResult(false)">不正解</button>
    </div>
  </section>

  <!-- データ管理 -->
  <section id="manage" class="card">
    <div class="toolbar">
      <input type="file" id="fileInput" accept=".csv,.json,text/csv,application/json" />
      <button class="btn" onclick="onImportClick()">インポート</button>
      <button class="btn" onclick="onExportCSV()">CSVエクスポート</button>
      <button class="btn" onclick="onExportJSON()">JSONエクスポート</button>
      <button class="btn" onclick="onAddClick()">行追加</button>
      <button class="btn" onclick="onDeleteSelected()">チェック削除</button>
      <button class="btn" onclick="importSeed(true)">サンプル読み込み（初期化）</button>
      <span class="muted">検索:</span><input id="txtFind" type="text" oninput="refresh()" placeholder="コード/名称/位置など" />
      <span id="info" class="muted"></span>
    </div>
    <div class="tableWrap" id="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="min-width:48px"><input type="checkbox" id="chkAll" onclick="onCheckAll(this)"></th>
            <th>コード</th><th>経穴名</th><th>経絡</th><th>読み</th>
            <th>位置(編集版)</th><th>位置(WHO要約)</th>
            <th>主治</th><th>その他メモ</th>
            <th>五兪穴</th><th>五行</th><th>編集済</th><th>有効</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- 説明 -->
  <section id="about" class="card">
    <h3>使い方</h3>
    <ol>
      <li>「データ管理」でCSV/JSONをインポート（Excelから保存OK）。</li>
      <li>「学習」で出題形式と順序を選び「開始」。<strong>クリック＝再生/停止、ダブルクリック/Enter＝一括表示、Space＝再生/停止</strong></li>
      <li>CSVヘッダは日本語もOK（<span class="muted">コード, 経穴名, 経絡, 読み, 位置(編集版), 位置(WHO要約), 主治, その他メモ, 五兪穴, 五行, 編集済, 有効</span>）。</li>
    </ol>
  </section>
</main>

<div id="toast"></div>

<!-- 初期サンプル（10穴・WHO要約） -->
<script type="application/json" id="seedData">
[
  {"コード":"LU-1","経穴名":"中府","経絡":"手太陰肺経","読み":"ちゅうふ","位置(編集版)":"","位置(WHO要約)":"前胸部、第1肋間、前正中線外6寸。","主治":"咳嗽、喘息、胸痛。","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1},
  {"コード":"LU-5","経穴名":"尺沢","経絡":"手太陰肺経","読み":"しゃくたく","位置(編集版)":"","位置(WHO要約)":"肘窩横紋、上腕二頭筋腱の橈側。","主治":"咳嗽、喘息、咽喉痛。","その他メモ":"","五兪穴":"合","五行":"水","編集済":0,"有効":1},
  {"コード":"LU-7","経穴名":"列缺","経絡":"手太陰肺経","読み":"れっけつ","位置(編集版)":"","位置(WHO要約)":"手関節横紋上1.5寸、橈骨茎状突起上。","主治":"外感風寒、頭痛、項強。","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1},
  {"コード":"LI-4","経穴名":"合谷","経絡":"手陽明大腸経","読み":"ごうこく","位置(編集版)":"","位置(WHO要約)":"第1・2中手骨間の中点。","主治":"頭痛、顔面痛、歯痛。","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1},
  {"コード":"ST-36","経穴名":"足三里","経絡":"足陽明胃経","読み":"あしさんり","位置(編集版)":"","位置(WHO要約)":"犢鼻下3寸、脛骨前縁外。","主治":"胃腸症状、全身調整。","その他メモ":"","五兪穴":"合","五行":"土","編集済":0,"有効":1},
  {"コード":"SP-6","経穴名":"三陰交","経絡":"足太陰脾経","読み":"さんいんこう","位置(編集版)":"","位置(WHO要約)":"内果上3寸、脛骨内縁後方。","主治":"月経不順、泌尿器症状。","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1},
  {"コード":"HT-7","経穴名":"神門","経絡":"手少陰心経","読み":"しんもん","位置(編集版)":"","位置(WHO要約)":"手関節横紋尺側端、尺側手根屈筋腱の橈側。","主治":"不眠、健忘、動悸。","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1},
  {"コード":"SI-3","経穴名":"後谿","経絡":"手太陽小腸経","読み":"こうけい","位置(編集版)":"","位置(WHO要約)":"第5中手指節関節後の陥凹部。","主治":"項背強直、頭痛。","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1},
  {"コード":"BL-40","経穴名":"委中","経絡":"足太陽膀胱経","読み":"いちゅう","位置(編集版)":"","位置(WHO要約)":"膝窩横紋中央。","主治":"腰痛、下肢麻痺、皮膚疾患。","その他メモ":"","五兪穴":"合","五行":"土","編集済":0,"有効":1},
  {"コード":"KI-3","経穴名":"太谿","経絡":"足少陰腎経","読み":"たいけい","位置(編集版)":"","位置(WHO要約)":"内果とアキレス腱の間の陥凹部。","主治":"腰痛、耳鳴、不眠。","その他メモ":"","五兪穴":"","五行":"","編集済":0,"有効":1}
]
</script>

<script>
/* ========= ユーティリティ ========= */
const el=id=>document.getElementById(id);
const STORAGE='keiketsu-mini-v970';
let data=[];

function show(id,btn){
  document.querySelectorAll('section.card').forEach(s=>s.classList.remove('active'));
  el(id).classList.add('active');
  document.querySelectorAll('nav .tabs button').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

let toastTimer;
function toast(msg){
  const t=el('toast'); t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),1200);
}

/* ========= キー正規化 & 正規化共通 ========= */
function normKey(s){ return String(s||'').replace(/\uFEFF/g,'').trim(); }
function hcanon(s){ return normKey(s).replace(/\s+/g,'').toLowerCase(); }

function normalizeObj(obj){
  const pick=(keys)=>{
    for(const k of keys){
      if(k in obj && obj[k]!=null && String(obj[k]).length) return String(obj[k]);
      const hit = Object.keys(obj).find(x=>hcanon(x)===hcanon(k));
      if(hit) return String(obj[hit]);
    }
    return '';
  };
  const rec = {
    code: normKey(pick(['コード','code','id'])),
    name: normKey(pick(['経穴名','name'])),
    meridian: normKey(pick(['経絡','meridian'])),
    reading: normKey(pick(['読み','reading'])),
    locationEdit: pick(['位置(編集版)','locedit']),
    locationWHO: pick(['位置(WHO要約)','位置(who要約)','locwho']),
    indications: pick(['主治','indications']),
    memo: pick(['その他メモ','memo']),
    shu: pick(['五兪穴','shu']),
    phase: pick(['五行','phase']),
    edited: Number(pick(['編集済','edited'])||0)?1:0,
    enabled: Number(pick(['有効','enabled'])||1)?1:0
  };
  rec.location = rec.locationEdit || rec.locationWHO || '';
  return rec;
}

/* ========= ストレージ ========= */
const save=()=>localStorage.setItem(STORAGE,JSON.stringify(data));
const load=()=>{ try{const raw=localStorage.getItem(STORAGE); if(raw) return JSON.parse(raw);}catch(e){} return null; };

/* ========= CSVパーサ（クォート対応） ========= */
function parseCSV(text){
  if(!text) return [];
  if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
  text=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const rows=[]; let i=0, field='', row=[], inQ=false;
  while(i<text.length){
    const ch=text[i];
    if(inQ){
      if(ch==='"'){
        if(text[i+1]==='"'){ field+='"'; i+=2; continue; }
        inQ=false; i++; continue;
      } else { field+=ch; i++; continue; }
    }else{
      if(ch==='"'){ inQ=true; i++; continue; }
      if(ch===','){ row.push(field); field=''; i++; continue; }
      if(ch==='\n'){ row.push(field); rows.push(row); row=[]; field=''; i++; continue; }
      field+=ch; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  return rows.filter(r=>r.some(c=>String(c).trim()!==''));
}

/* ========= インポート ========= */
async function onImportClick(){
  const fi=el('fileInput');
  if(!fi.files||!fi.files.length){ alert('CSV/JSONを選択してください'); return; }
  await importFromFile(fi.files[0]); fi.value='';
}

async function importFromFile(file){
  try{
    const buf=await file.arrayBuffer();
    let text=new TextDecoder('utf-8',{fatal:false}).decode(buf);

    if(file.name.toLowerCase().endsWith('.json')){
      const arr=JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('JSONは配列である必要があります');
      const norm=arr.map(x=>normalizeObj(x)).filter(x=>x.code||x.name);
      mergeData(norm);
      toast(`インポート（JSON）：${norm.length}件`);
      return;
    }

    const table=parseCSV(text);
    if(!table.length) throw new Error('CSVが空です');
    const headers=table[0];
    const arr=[];
    for(let r=1;r<table.length;r++){
      const row=table[r];
      const obj={};
      headers.forEach((h,i)=>obj[h]=row[i]??'');
      arr.push(normalizeObj(obj));
    }
    const norm=arr.filter(x=>x.code||x.name);
    mergeData(norm);
    toast(`インポート（CSV）：${norm.length}件`);
  }catch(e){
    alert('インポート失敗: '+e.message);
  }
}

function importFromText(text){
  try{
    const table=parseCSV(text);
    if(!table.length) return 0;
    const headers=table[0];
    const arr=[];
    for(let r=1;r<table.length;r++){
      const row=table[r], obj={};
      headers.forEach((h,i)=>obj[h]=row[i]??'');
      arr.push(normalizeObj(obj));
    }
    const norm=arr.filter(x=>x.code||x.name);
    mergeData(norm);
    return norm.length;
  }catch(e){
    alert('貼付インポート失敗: '+e.message);
    return 0;
  }
}

/* ========= サンプル読み込み（初期化） ========= */
async function importSeed(force=false){
  if(force && !confirm('ローカル保存を初期化してサンプルを読み込みます。よろしいですか？')) return;
  const saved=load();
  if(!force && saved && saved.length){
    data=saved;
    refresh();
    return;
  }
  try{
    const raw=JSON.parse(el('seedData').textContent);
    if(!Array.isArray(raw)) throw new Error('seedData は配列JSONである必要があります');
    const norm=raw.map(x=>normalizeObj(x)).filter(x=>x.code||x.name);
    data=norm;
    save(); refresh();
    toast(`サンプル読込：${norm.length}件`);
  }catch(e){
    alert('サンプル読込に失敗: '+e.message);
  }
}

/* ========= エクスポート ========= */
function onExportCSV(){
  const headers=['コード','経穴名','経絡','読み','位置(編集版)','位置(WHO要約)','主治','その他メモ','五兪穴','五行','編集済','有効'];
  const lines=[headers.join(',')];
  for(const d of data){
    const row=[
      d.code||'', d.name||'', d.meridian||'', d.reading||'',
      d.locationEdit||'', d.locationWHO||'', d.indications||'', d.memo||'',
      d.shu||'', d.phase||'', d.edited||0, d.enabled||1
    ].map(v=>{
      const s=String(v??'');
      return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;
    }).join(',');
    lines.push(row);
  }
  const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='keiketsu.csv'; a.click();
  URL.revokeObjectURL(url);
}
function onExportJSON(){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='keiketsu.json'; a.click();
  URL.revokeObjectURL(url);
}

/* ========= データ結合 ========= */
function keyOf(d){ return (d.code||d.name||'').trim(); }
function indexByKey(k){ return data.findIndex(x=>keyOf(x)===k); }
function mergeData(arr){
  const mp=new Map(data.map(x=>[keyOf(x),x]));
  let add=0, upd=0;
  for(const it of arr){
    const k=keyOf(it); if(!k) continue;
    if(mp.has(k)){ mp.set(k,Object.assign({},mp.get(k),it)); upd++; }
    else { mp.set(k,it); add++; }
  }
  data=[...mp.values()];
  save(); refresh();
  toast(`追加 ${add} / 更新 ${upd} / 合計 ${data.length}`);
}

/* ========= テーブル描画 / 編集 ========= */
function renderTable(){
  const q=(el('txtFind').value||'').trim().toLowerCase();
  const tb=el('tbody'); tb.innerHTML='';
  const filtered=data.filter(d=>{
    const s=[d.code,d.name,d.meridian,d.reading,d.locationEdit,d.locationWHO,d.indications,d.memo,d.shu,d.phase].join(' ').toLowerCase();
    return !q || s.includes(q);
  });
  for(const d of filtered){
    const key=keyOf(d);
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="chkRow" data-key="${key}"></td>
      <td contenteditable>${d.code||''}</td>
      <td contenteditable>${d.name||''}</td>
      <td contenteditable>${d.meridian||''}</td>
      <td contenteditable>${d.reading||''}</td>
      <td contenteditable>${d.locationEdit||''}</td>
      <td contenteditable>${d.locationWHO||''}</td>
      <td contenteditable>${d.indications||''}</td>
      <td contenteditable>${d.memo||''}</td>
      <td contenteditable>${d.shu||''}</td>
      <td contenteditable>${d.phase||''}</td>
      <td contenteditable>${d.edited||0}</td>
      <td contenteditable>${d.enabled??1}</td>
      <td><button class="btn" onclick="rowDup('${key.replace(/'/g,"\\'")}')">複製</button></td>
    `;
    tr.addEventListener('focusout',ev=>{
      const row=ev.currentTarget;
      const tds=row.querySelectorAll('td');
      const obj=normalizeObj({
        'コード':tds[1].textContent,
        '経穴名':tds[2].textContent,
        '経絡':tds[3].textContent,
        '読み':tds[4].textContent,
        '位置(編集版)':tds[5].textContent,
        '位置(WHO要約)':tds[6].textContent,
        '主治':tds[7].textContent,
        'その他メモ':tds[8].textContent,
        '五兪穴':tds[9].textContent,
        '五行':tds[10].textContent,
        '編集済':tds[11].textContent,
        '有効':tds[12].textContent
      });
      const oldIdx=indexByKey(key);
      if(oldIdx>=0) data[oldIdx]=Object.assign({},data[oldIdx],obj);
      else data.push(obj);
      save();
      data = data.map(x=>Object.assign(x,{location:x.locationEdit||x.locationWHO||''}));
    }, {capture:true});
    tb.appendChild(tr);
  }
  el('info').textContent = `登録：${data.length}件 / 表示：${filtered.length}件`;
}
function refresh(){ renderTable(); }
function onCheckAll(box){ document.querySelectorAll('.chkRow').forEach(ch=>ch.checked=box.checked); }
function onAddClick(){
  let base='NEW',n=1; while(indexByKey(base+n)!==-1) n++;
  data.unshift(normalizeObj({'コード':base+n,'経穴名':'','経絡':'','読み':'','位置(編集版)':'','位置(WHO要約)':'','主治':'','その他メモ':'','五兪穴':'','五行':'','編集済':0,'有効':1}));
  save(); refresh(); toast('1行追加');
}
function onDeleteSelected(){
  const keys=Array.from(document.querySelectorAll('.chkRow:checked')).map(c=>c.dataset.key);
  if(!keys.length){ alert('削除する行にチェックを付けてください'); return; }
  if(!confirm(`${keys.length} 行を削除しますか？`)) return;
  data = data.filter(x=>!keys.includes(keyOf(x)));
  save(); refresh(); toast('削除しました');
}
function rowDup(key){
  const i=indexByKey(key); if(i<0) return;
  const src=data[i];
  let c=(src.code||src.name||'COPY')+'_copy', k=1;
  while(indexByKey(c)!==-1) c=(src.code||src.name||'COPY')+'_copy'+(++k);
  const dup=Object.assign({},src,{code:c});
  data.splice(i+1,0,dup); save(); refresh(); toast('複製しました');
}

/* ========= 学習ロジック ========= */
const PRESETS={
  'code->name':{qKey:'code', aKey:'name'},
  'name->location':{qKey:'name', aKey:'location'},
  'name->indications':{qKey:'name', aKey:'indications'},
  'location->name':{qKey:'location', aKey:'name'}
};
const PREFIX_ORDER=['CV','GV','LU','LI','ST','SP','HT','SI','BL','KI','PC','SJ','GB','LV'];
const PREFIX_RANK=Object.fromEntries(PREFIX_ORDER.map((p,i)=>[p,i]));
function codeParts(code){
  const s=String(code||'').toUpperCase().trim();
  const m=s.match(/^([A-Z]+)[-]?(\d+)$/);
  if(m) return {prefix:m[1],num:parseInt(m[2],10),raw:s};
  return {prefix:s,num:Number.MAX_SAFE_INTEGER,raw:s};
}
function applyPreset(session){
  const p=PRESETS[el('qaPreset').value]||PRESETS['name->location'];
  session.qKey=p.qKey; session.aKey=p.aKey;
}
function orderPool(pool, mode){
  if(mode!=='code') return shuffle(pool);
  return pool.slice().sort((a,b)=>{
    const pa=codeParts(a.code), pb=codeParts(b.code);
    const ra=(PREFIX_RANK[pa.prefix]??999), rb=(PREFIX_RANK[pb.prefix]??999);
    if(ra!==rb) return ra-rb;
    if(pa.num!==pb.num) return pa.num-pb.num;
    return (pa.raw||'').localeCompare(pb.raw||'');
  });
}
function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}

let session={list:[],i:0,mode:'flash',qKey:'name',aKey:'location',correct:0,wrong:0,started:false,requeueWrong:true};

/* === 再生制御 === */
let playing=false;
let autoTimer=null;
const AUTO_MS_FRONT=2500;  // 表の表示時間
const AUTO_MS_BACK=3000;   // 裏の表示時間
let showingBack=false;     // 現在のカードが裏表示か

function start(){
  session.mode=el('mode').value;
  applyPreset(session);
  session.requeueWrong = el('requeueWrong').checked;
  const useMax = el('chkMax').checked;
  let limit = parseInt(el('limit').value||'20',10); if(isNaN(limit)||limit<1) limit=20;

  data = data.map(x=>Object.assign(x,{location:x.locationEdit||x.locationWHO||''}));

  let pool = data.filter(x=>(x[session.qKey]||'').trim() && (x[session.aKey]||'').trim() && (x.enabled??1));
  pool = orderPool(pool, el('order').value);
  const finalLimit = useMax ? pool.length : Math.min(Math.max(5,limit),Math.max(5,pool.length));

  session.list = pool.slice(0,finalLimit);
  session.i=0; session.correct=0; session.wrong=0; session.started = session.list.length>0;
  showingBack=false; stopAuto();

  if(!session.started){
    el('qText').textContent='該当データがありません';
    el('aText').textContent='出題形式・CSV/JSONをご確認ください';
    el('mcqArea').classList.add('hidden');
    el('progress').textContent='';
    return;
  }
  if(session.mode==='mcq'){ showMCQ(); }
  else { showFront(); }
  updateProgress();
  toast('開始しました');
}

function endSession(){
  session.started=false; session.list=[]; session.i=0; session.correct=0; session.wrong=0;
  stopAuto();
  el('qText').textContent='終了しました';
  el('aText').textContent=''; el('subText').textContent='クリック＝再生/停止　／　ダブルクリック or Enter＝一括表示　／　Space＝再生/停止';
  el('mcqArea').classList.add('hidden');
  el('progress').textContent='';
  showingBack=false;
}

function current(){ return session.list[session.i]; }
function labelFor(k){ return ({code:'コード',name:'経穴名',location:'位置',indications:'主治'})[k]||k; }

/* === 表示作成（回答強調） === */
function fmtAnswerText(k, it){
  let val='';
  if(k==='location') val = it.location || '';
  else if(k==='indications') val = it.indications || '';
  else if(k==='name') val = it.name || '';
  else if(k==='code') val = it.code || '';
  return `<span class="ans-strong">${escapeHTML(val||'—')}</span>`;
}
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function showFront(){
  const it=current();
  el('qText').textContent = `${labelFor(session.qKey)}：${it[session.qKey]||'—'}`;
  el('aText').textContent = '';
  el('subText').textContent='クリック＝再生/停止　／　ダブルクリック or Enter＝一括表示　／　Space＝再生/停止';
  el('mcqArea').classList.add('hidden');
  showingBack=false;
}
function showBack(){
  const it=current();
  const answerLine = `${labelFor(session.aKey)}：${fmtAnswerText(session.aKey,it)}`;
  const linesHTML=[
    answerLine,
    `コード：${escapeHTML(it.code||'—')}　経穴名：${escapeHTML(it.name||'—')}　経絡：${escapeHTML(it.meridian||'—')}`,
    `位置(編集版)：${escapeHTML(it.locationEdit||'—')}`,
    `位置(WHO要約)：${escapeHTML(it.locationWHO||'—')}`,
    `主治：${escapeHTML(it.indications||'—')}`,
    `その他：${escapeHTML(it.memo||'—')}`
  ].join('\n');
  el('aText').innerHTML = linesHTML.replace(/\n/g,'<br>');
  el('subText').textContent='クリック＝再生/停止　／　ダブルクリック or Enter＝一括表示　／　Space＝再生/停止';
  el('mcqArea').classList.add('hidden');
  showingBack=true;
}
/* 一括表示（表＋裏まとめて） */
function showBoth(){
  if(!session.started || session.mode==='mcq') return;
  const it=current();
  const q = `${labelFor(session.qKey)}：${escapeHTML(it[session.qKey]||'—')}`;
  const a = `${labelFor(session.aKey)}：${fmtAnswerText(session.aKey,it)}`;
  const linesHTML=[
    `<div>${q}</div>`,
    `<div>${a}</div>`,
    `<div>コード：${escapeHTML(it.code||'—')}　経穴名：${escapeHTML(it.name||'—')}　経絡：${escapeHTML(it.meridian||'—')}</div>`,
    `<div>位置(編集版)：${escapeHTML(it.locationEdit||'—')}</div>`,
    `<div>位置(WHO要約)：${escapeHTML(it.locationWHO||'—')}</div>`,
    `<div>主治：${escapeHTML(it.indications||'—')}</div>`,
    `<div>その他：${escapeHTML(it.memo||'—')}</div>`
  ].join('');
  el('aText').innerHTML = linesHTML;
  el('qText').textContent='';
  showingBack=true;
}

/* 既存フリップ（内部用） */
function flip(){
  if(!session.started || session.mode==='mcq') return;
  if(showingBack) showFront(); else showBack();
}
function flashClick(){ flip(); }

function updateProgress(){
  el('progress').textContent=`進捗：${session.i+1}/${session.list.length}（正 ${session.correct}・誤 ${session.wrong}）`;
}

function handleWrongRequeue(it){
  if(!session.requeueWrong) return;
  session.list.push(it);
}
function next(){
  session.i++;
  if(session.i>=session.list.length){
    el('qText').textContent='セッション完了！';
    el('aText').textContent=`正解 ${session.correct} / 不正解 ${session.wrong}`;
    el('subText').textContent=''; el('mcqArea').classList.add('hidden');
    el('progress').textContent='';
    session.started=false; stopAuto(); return;
  }
  if(session.mode==='mcq') showMCQ(); else { showFront(); }
  updateProgress();
}
function markResult(ok){
  if(!session.started) return;
  const it=current();
  if(ok){ session.correct++; toast('正解'); }
  else { session.wrong++; handleWrongRequeue(it); toast('不正解'); }
  next();
}

/* 四択 */
function showMCQ(){
  const it=current();
  el('qText').textContent=`${labelFor(session.qKey)}：${it[session.qKey]||'—'}`;
  el('aText').textContent=''; el('subText').textContent='';
  const area=el('mcqArea'); area.innerHTML=''; area.classList.remove('hidden');
  const opts=pickOptions(it,session.aKey);
  opts.forEach(o=>{
    const b=document.createElement('button');
    b.className='btn'; b.textContent=o[session.aKey]||'（未設定）';
    b.onclick=()=>{
      if(o===it){ b.classList.add('primary'); session.correct++; toast('正解'); }
      else { b.style.borderColor='#e11d48'; b.style.color='#e11d48'; session.wrong++; handleWrongRequeue(it); toast('不正解'); }
      setTimeout(next,220);
    };
    area.appendChild(b);
  });
}
function pickOptions(target,aKey){
  const pool=data.filter(x=>(x[aKey]||'').trim());
  const uniq=[]; const seen=new Set();
  for(const x of pool){ const v=x[aKey]; if(!seen.has(v)){ uniq.push(x); seen.add(v); } }
  const opts=[target];
  while(opts.length<4 && uniq.length){
    const idx=Math.floor(Math.random()*uniq.length);
    const cand=uniq.splice(idx,1)[0];
    if(cand[aKey]!==target[aKey]) opts.push(cand);
  }
  while(opts.length<4) opts.push(target);
  return shuffle(opts);
}

/* === 自動再生 === */
function stopAuto(){ playing=false; if(autoTimer){ clearTimeout(autoTimer); autoTimer=null; } }
function startAuto(){
  if(session.mode==='mcq') return;   // 四択では自動再生しない
  playing=true;
  runTick();
}
function toggleAuto(){ if(playing){ stopAuto(); toast('一時停止'); } else { startAuto(); toast('再生'); } }
function runTick(){
  if(!playing || !session.started) { stopAuto(); return; }
  if(!showingBack){
    showBack();
    autoTimer=setTimeout(runTick, AUTO_MS_BACK);
  }else{
    next();
    if(session.started){ showFront(); autoTimer=setTimeout(runTick, AUTO_MS_FRONT); }
  }
}

/* === クリック/ダブルクリック/キー操作 === */
const displayEl = document.getElementById('display');
displayEl.addEventListener('click', ()=>{
  if(!session.started) return;
  toggleAuto();      // シングルクリック＝再生/停止
});
displayEl.addEventListener('dblclick', ()=>{
  if(!session.started) return;
  showBoth();        // ダブルクリック＝一括表示
});
document.addEventListener('keydown',e=>{
  if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName)) return;
  if(e.key===' '){ e.preventDefault(); if(session.started) toggleAuto(); }
  else if(e.key==='Enter'){ e.preventDefault(); if(session.started) showBoth(); }
});

/* ========= 初期化 ========= */
(function init(){
  const saved=load();
  if(saved && saved.length){
    data=saved.map(normalizeObj).filter(x=>x.code||x.name);
  }else{
    importSeed(false);
  }
  refresh();
})();
</script>
</body>
</html>
