<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Keiketsu Mini v9</title>
<style>
body{font-family:sans-serif;margin:0;padding:0;}
header{background:#4682b4;color:#fff;padding:10px;}
main{padding:10px;}
button{margin:2px;}
#toast{visibility:hidden;min-width:120px;background:#333;color:#fff;
  text-align:center;border-radius:2px;padding:5px;position:fixed;z-index:1;
  left:50%;bottom:30px;transform:translateX(-50%);}
#toast.show{visibility:visible;animation:fadein 0.5s, fadeout 0.5s 1.5s;}
@keyframes fadein{from{bottom:20px;opacity:0} to{bottom:30px;opacity:1}}
@keyframes fadeout{from{bottom:30px;opacity:1} to{bottom:40px;opacity:0}}
/* テーブルエリア */
#gridMain{overflow:auto;height:300px;border:1px solid #ccc;}
table{border-collapse:collapse;min-width:1200px;}
th,td{border:1px solid #ccc;padding:4px;white-space:nowrap;}
td[contenteditable=true]{background:#fdfdfd;}
/* 上部スクロール */
.hscroll-top{overflow-x:auto;overflow-y:hidden;height:16px;}
.hscroll-top div{height:1px;}
</style>
</head>
<body>
<header>
<h1>Keiketsu Mini v9</h1>
</header>
<main>
<div>
  <button onclick="start()">開始</button>
  <button onclick="endSession()">終了</button>
  <select id="mode">
    <option value="flash">フラッシュカード</option>
    <option value="mcq">四択クイズ</option>
  </select>
  出題数:<input id="limit" type="number" value="10" style="width:50px;">
  <label><input type="checkbox" id="chkMax">最大</label>
  <select id="order">
    <option value="random">ランダム</option>
    <option value="code">コード順</option>
  </select>
  <label><input type="checkbox" id="requeueWrong" checked>間違えた問題を最後に再出題</label>
  <select id="qaPreset">
    <option value="name->location">経穴名→位置</option>
    <option value="code->name">コード→経穴名</option>
    <option value="name->indications">経穴名→主治</option>
    <option value="code->location">コード→位置</option>
    <option value="location->name">位置→経穴名</option>
  </select>
</div>

<hr>
<div id="qText">「開始」を押してください</div>
<div id="aText"></div>
<div id="subText"></div>
<div id="mcqArea" class="hidden"></div>
<div id="progress"></div>

<hr>
<h3>データ管理</h3>
<input id="txtFind" placeholder="検索" oninput="renderTable()">
<button onclick="onAddClick()">追加</button>
<button onclick="onDeleteSelected()">選択削除</button>
<button onclick="onExportCSV()">CSV出力</button>
<button onclick="onExportJSON()">JSON出力</button>
<input type="file" id="fileInput">
<button onclick="onImportClick()">インポート</button>
<button onclick="onBulkPasteOpen()">一括貼付</button>
<dialog id="dlgPaste">
  <textarea id="taPaste" style="width:90%;height:200px;"></textarea>
  <div>
    <button onclick="onPasteApply()">取込</button>
    <button onclick="onPasteCancel()">キャンセル</button>
  </div>
</dialog>
<div class="hscroll-top" id="hscrollTop" onscroll="el('gridMain').scrollLeft=this.scrollLeft">
  <div id="hscrollDummy"></div>
</div>
<div id="gridMain" onscroll="el('hscrollTop').scrollLeft=this.scrollLeft">
  <table id="dataTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAll" onclick="onCheckAll(this)"></th>
        <th>コード</th><th>経穴名</th><th>経絡</th><th>読み</th>
        <th>位置</th><th>主治</th><th>その他メモ</th><th>五兪穴</th><th>五行</th>
        <th>編集済</th><th>有効</th><th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
</main>
<div id="toast"></div>

<!-- 初期サンプルデータ（10件程度） -->
<script id="seedData" type="application/json">
[
  {"code":"LU1","name":"中府","meridian":"手の太陰肺経","reading":"ちゅうふ",
   "location":"第1肋間、前正中線の外方6寸","indications":"咳、喘息、胸痛、肩背部の痛み",
   "memo":"WHO要約サンプル","shu":"井","phase":"木","edited":"","enabled":"1"},
  {"code":"LU5","name":"尺沢","meridian":"手の太陰肺経","reading":"しゃくたく",
   "location":"肘窩横紋上、上腕二頭筋腱の橈側","indications":"咳、喘息、喉の痛み、上肢の麻痺",
   "memo":"","shu":"合","phase":"水","edited":"","enabled":"1"},
  {"code":"LI4","name":"合谷","meridian":"手の陽明大腸経","reading":"ごうこく",
   "location":"第1・第2中手骨の間、第2中手骨の中点橈側","indications":"頭痛、歯痛、顔面神経麻痺、発熱",
   "memo":"","shu":"原","phase":"","edited":"","enabled":"1"}
]
</script>

<script>
// ===== ユーティリティ =====
const el=id=>document.getElementById(id);
const STORAGE='keiketsu-mini-v9';

let data=[],filtered=[];

// ===== データ保存・読込 =====
const save=()=>localStorage.setItem(STORAGE,JSON.stringify(data));
const load=()=>{try{const raw=localStorage.getItem(STORAGE);if(raw)return JSON.parse(raw);}catch(e){}return null};

// ===== 学習用セッション（簡略版） =====
let session={started:false,list:[],i:0,correct:0,wrong:0,qKey:'name',aKey:'location',mode:'flash'};

function start(){
  session.started=true;
  session.i=0;
  session.correct=0; session.wrong=0;
  session.mode=el('mode').value;
  showFront();
}
function endSession(){session.started=false;el('qText').textContent="終了しました";}
function current(){return session.list[session.i]||{}}
function showFront(){el('qText').textContent="問題：サンプル表示";el('aText').textContent="";}
function renderTable(){
  const tb=el('tbody');tb.innerHTML='';
  for(const d of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" class="chkRow" data-key="${d.code}"></td>
<td contenteditable="true" data-key="code">${d.code||''}</td>
<td contenteditable="true" data-key="name">${d.name||''}</td>
<td contenteditable="true" data-key="meridian">${d.meridian||''}</td>
<td contenteditable="true" data-key="reading">${d.reading||''}</td>
<td contenteditable="true" data-key="location">${d.location||''}</td>
<td contenteditable="true" data-key="indications">${d.indications||''}</td>
<td contenteditable="true" data-key="memo">${d.memo||''}</td>
<td contenteditable="true" data-key="shu">${d.shu||''}</td>
<td contenteditable="true" data-key="phase">${d.phase||''}</td>
<td contenteditable="true" data-key="edited">${d.edited||''}</td>
<td><input type="checkbox" data-key="enabled" ${d.enabled!=="0"?"checked":""}></td>
<td><button onclick="rowDup('${d.code}')">複製</button>
<button onclick="rowDel('${d.code}')">削除</button></td>`;
    tb.appendChild(tr);
  }
}

// ===== インポート（初期データ or 保存データ） =====
async function importSeed(){
  try{
    const saved=load();
    if(saved&&saved.length){data=saved;return;}
    const tag=el('seedData');
    data=JSON.parse(tag.textContent);
    save();
  }catch(e){data=[];save();}
}

// ===== 操作 =====
function rowDel(key){data=data.filter(x=>x.code!==key);save();renderTable();}
function rowDup(key){const it=data.find(x=>x.code===key);if(!it)return;
  const copy=Object.assign({},it,{code:it.code+"_copy"});data.push(copy);save();renderTable();}

// ===== 初期化 =====
function init(){
  importSeed();renderTable();
  adjustTopBarWidth(); // 初期調整
}
window.onload=init;

// ===== 上下スクロールバー幅調整 =====
function adjustTopBarWidth(){
  const grid=el('gridMain'), topBar=el('hscrollTop'), dummy=el('hscrollDummy');
  if(!grid||!topBar||!dummy)return;
  dummy.style.width=(el('dataTable').scrollWidth||1200)+'px';
  const sbw=grid.offsetWidth-grid.clientWidth;
  topBar.style.paddingRight=sbw>0?(sbw+'px'):'0px';
}
window.addEventListener('resize',adjustTopBarWidth);
</script>
</body>
</html>
