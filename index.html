<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Keiketsu Mini v8.8（WHO原文×編集版 二層管理）</title>
<meta name="theme-color" content="#0ea5e9"/>
<style>
:root{--bg:#fff;--fg:#111;--primary:#0ea5e9;--card:#f8fafc;--border:#e5e7eb}
*{box-sizing:border-box}html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--fg);background:var(--bg)}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:10px}
header h1{font-size:16px;margin:0;font-weight:700}
nav{margin-left:auto;display:flex;gap:8px}
nav button{border:1px solid var(--border);background:#fff;padding:8px 10px;border-radius:10px;font-size:14px;cursor:pointer}
nav button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
main{padding:14px;max-width:1240px;margin:0 auto}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
select,input,button,textarea{font-size:14px}
select,input[type=number],input[type=file],input[type=text],textarea{padding:8px;border:1px solid var(--border);border-radius:10px;background:#fff}
.btn{padding:9px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff;border-color:#0ea5e9}
.btn.success{background:#10b981;color:#fff;border-color:#10b981}
.btn.warn{background:#f59e0b;color:#fff;border-color:#f59e0b}
.btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
.grid{border:1px solid var(--border);border-radius:10px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed}
th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
th{background:#f1f5f9;position:sticky;top:0;z-index:1}
.hidden{display:none}.small{font-size:12px;color:#6b7280}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e0f2fe;color:#075985;font-size:12px;margin-right:6px}
.pill.alt{background:#ecfdf5;color:#065f46}
.flash-area{min-height:270px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px;text-align:center}
.q{font-size:22px;font-weight:700}.a{font-size:16px}
.mcq{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
.mcq button{text-align:left}
.correct{outline:2px solid #10b981}.wrong{outline:2px solid #ef4444}
#toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:999px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s}
#toast.show{opacity:.9}
th.col-code,td[data-key=code]{width:86px}
th.col-name,td[data-key=name]{width:120px}
th.col-meridian,td[data-key=meridian]{width:160px}
th.col-reading,td[data-key=reading]{width:110px}
th.col-enabled{width:64px}
th.col-shu,td[data-key=shu]{width:56px}th.col-phase,td[data-key=phase]{width:56px}
th.col-loc-who,td[data-key=location_who],th.col-loc-edit,td[data-key=location_edit]{width:360px;white-space:normal!important;word-break:break-word;overflow-wrap:anywhere}
.badge{margin-left:8px;padding:2px 8px;border-radius:999px;background:#ecfccb;color:#3f6212;border:1px solid #d9f99d;font-size:12px}
</style>
</head>
<body>
  <header>
    <h1>Keiketsu Mini v8.8<span class="badge">WHO原文×編集版 二層</span></h1>
    <nav>
      <button id="tabStudy" class="active" onclick="show('viewStudy','tabStudy')">学習</button>
      <button id="tabManage" onclick="show('viewManage','tabManage')">データ管理</button>
      <button id="tabAbout" onclick="show('viewAbout','tabAbout')">説明</button>
    </nav>
  </header>

  <main>
    <section id="viewStudy">
      <div class="toolbar">
        <label>モード
          <select id="mode">
            <option value="flash">フラッシュカード</option>
            <option value="mcq">四択クイズ</option>
          </select>
        </label>
        <label>出題形式
          <select id="qaPreset">
            <option value="name->location" selected>経穴名 → 位置（編集版優先）</option>
            <option value="code->name">コード → 経穴名</option>
            <option value="name->indications">経穴名 → 主治</option>
            <option value="code->location">コード → 位置（編集版優先）</option>
            <option value="location->name">位置（編集版優先） → 経穴名</option>
          </select>
        </label>
        <label>順序
          <select id="order">
            <option value="random">ランダム</option>
            <option value="code">コード順</option>
          </select>
        </label>
        <label>経絡
          <select id="filterMeridian"><option value="">（すべて）</option></select>
        </label>
        <label>五兪穴
          <select id="filterShu"><option value="">（指定なし）</option><option>井</option><option>滎</option><option>兪</option><option>経</option><option>合</option></select>
        </label>
        <label>五行
          <select id="filterPhase"><option value="">（指定なし）</option><option>木</option><option>火</option><option>土</option><option>金</option><option>水</option></select>
        </label>
        <label>出題数
          <input type="number" id="limit" min="5" max="9999" value="20" style="width:84px">
          <label class="small"><input type="checkbox" id="chkMax"> 最大（全件）</label>
        </label>
        <label><input type="checkbox" id="requeueWrong" checked> 間違えた問題を最後に再出題</label>
        <button class="btn primary" id="btnStart" type="button" onclick="start(true)">開始</button>
        <button class="btn" id="btnEnd" type="button" onclick="endSession()">終了</button>
        <span class="small" id="info"></span>
      </div>

      <div class="card">
        <div class="flash-area" id="flash" tabindex="0" aria-label="flashcard" onclick="flashClick()">
          <div class="q" id="qText">「開始」を押してください</div>
          <div class="a" id="aText"></div>
          <div class="small" id="subText"></div>
          <div class="mcq hidden" id="mcqArea"></div>
        </div>
        <div class="toolbar" style="justify-content:center;gap:12px;">
          <button class="btn" id="btnFlip" type="button" onclick="flip()">答えを表示/裏面にする</button>
          <button class="btn danger" id="btnWrong" type="button" onclick="markResult(false)">× わからない</button>
          <button class="btn success" id="btnRight" type="button" onclick="markResult(true)">○ 正解</button>
        </div>
        <div class="small" id="progress"></div>
      </div>
    </section>

    <section id="viewManage" class="hidden">
      <div class="toolbar">
        <input type="file" id="fileInput" accept=".csv,.json">
        <button class="btn" onclick="onImportClick()">インポート</button>
        <button class="btn" onclick="onAddClick()">行を追加</button>
        <button class="btn warn" onclick="onBulkPasteOpen()">一括貼り付け</button>
        <button class="btn danger" onclick="onDeleteSelected()">選択行を削除</button>
        <button class="btn" onclick="onExportCSV()">CSVを書き出し</button>
        <button class="btn" onclick="onExportJSON()">JSONを書き出し</button>
        <input type="text" id="txtFind" placeholder="検索（コード/経穴名/位置/主治/その他/五兪穴/五行）" style="flex:1;min-width:200px" oninput="renderTable()">
      </div>
      <div class="grid" style="margin-top:10px">
        <table>
          <thead><tr>
            <th style="width:28px"><input type="checkbox" id="chkAll" onclick="onCheckAll(this)"></th>
            <th class="col-code">コード</th>
            <th class="col-name">経穴名</th>
            <th class="col-meridian">経絡</th>
            <th class="col-reading">読み</th>
            <th class="col-loc-who">位置（WHO原文）</th>
            <th class="col-loc-edit">位置（編集版・出題に使用）</th>
            <th>主治</th>
            <th>その他メモ</th>
            <th class="col-shu">五兪穴</th>
            <th class="col-phase">五行</th>
            <th style="width:78px">編集済</th>
            <th class="col-enabled">有効</th>
            <th style="width:120px">操作</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section id="viewAbout" class="hidden">
      <div class="card"><h3>このアプリについて（v8.8）</h3>
        <ul>
          <li>位置テキストを <b>WHO原文</b> と <b>編集版</b> の二層で管理。出題は編集版を優先（編集版が空ならWHO原文）。</li>
          <li>「編集済」フラグで校正の進捗管理が可能。</li>
          <li>CSV/JSONは <code>位置(WHO原文)</code> / <code>位置(編集版)</code> / <code>編集済</code> / <code>有効</code> に対応。旧CSVも取り込めます。</li>
          <li>コード順：CV→GV→十二正経（LU→LI→ST→SP→HT→SI→BL→KI→PC→SJ→GB→LV）。</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- 一括貼り付け -->
  <dialog id="dlgPaste">
    <h3>一括貼り付け</h3>
    <p class="small">
      列順おすすめ：<br>
      <code>コード,経穴名,経絡,読み,位置(WHO原文),位置(編集版),主治,その他メモ,五兪穴,五行,編集済,有効</code><br>
      ※ 旧式の <code>位置</code> だけでも取り込めます（編集版として扱います）
    </p>
    <textarea id="taPaste" rows="10" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:10px"></textarea>
    <div style="margin-top:10px;text-align:right">
      <button class="btn" onclick="onPasteCancel()">キャンセル</button>
      <button class="btn primary" onclick="onPasteApply()">取り込む</button>
    </div>
  </dialog>

  <!-- 初期データ（例：少数） -->
  <script type="application/json" id="seedData">
  [
    {"code":"CV12","name":"中脘","meridian":"任脈","reading":"ちゅうかん","location_who":"臍の上4寸、前正中線上","location_edit":"","indications":"胃痛、消化不良、嘔吐、食欲不振","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"GV14","name":"大椎","meridian":"督脈","reading":"だいつい","location_who":"第7頚椎棘突起下、後正中線上","location_edit":"","indications":"風邪、発熱、頚肩の痛み","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"LU1","name":"中府","meridian":"手の太陰肺経","reading":"ちゅうふ","location_who":"第1肋間、前正中線の外方6寸","location_edit":"","indications":"咳、喘息、胸痛","memo":"","shu":"","phase":"","edited":0,"enabled":1},
    {"code":"LI11","name":"曲池","meridian":"手の陽明大腸経","reading":"きょくち","location_who":"肘を屈曲してできる横紋の外側端","location_edit":"","indications":"発熱、皮膚疾患、高血圧","memo":"","shu":"","phase":"","edited":0,"enabled":1}
  ]
  </script>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- ==== アプリ本体 JS ==== -->
  <script>
  // タブ表示切替
  function show(viewId,tabId){
    ['viewStudy','viewManage','viewAbout'].forEach(function(id){var sec=document.getElementById(id); if(sec) sec.classList.add('hidden')});
    var v=document.getElementById(viewId); if(v) v.classList.remove('hidden');
    ['tabStudy','tabManage','tabAbout'].forEach(function(id){var b=document.getElementById(id); if(b) b.classList.remove('active')});
    var t=document.getElementById(tabId); if(t) t.classList.add('active');
  }

  // ===== 定数/ユーティリティ =====
  function el(id){return document.getElementById(id)}
  var STORAGE='keiketsu-mini-v88'; // ★全員初期化したい時はキーを上げる
  var YIN=new Set(['手の太陰肺経','手の厥陰心包経','手の少陰心経','足の太陰脾経','足の少陰腎経','足の厥陰肝経']);
  var PHASE_SEQ_YIN=['木','火','土','金','水'], PHASE_SEQ_YANG=['金','水','木','火','土'];
  var SHU_POINTS={'手の太陰肺経':{'井':'LU11','滎':'LU10','兪':'LU9','経':'LU8','合':'LU5'},'手の陽明大腸経':{'井':'LI1','滎':'LI2','兪':'LI3','経':'LI5','合':'LI11'},'足の陽明胃経':{'井':'ST45','滎':'ST44','兪':'ST43','経':'ST41','合':'ST36'},'足の太陰脾経':{'井':'SP1','滎':'SP2','兪':'SP3','経':'SP5','合':'SP9'},'手の少陰心経':{'井':'HT9','滎':'HT8','兪':'HT7','経':'HT4','合':'HT3'},'手の太陽小腸経':{'井':'SI1','滎':'SI2','兪':'SI3','経':'SI5','合':'SI8'},'足の太陽膀胱経':{'井':'BL67','滎':'BL66','兪':'BL65','経':'BL60','合':'BL40'},'足の少陰腎経':{'井':'KI1','滎':'KI2','兪':'KI3','経':'KI7','合':'KI10'},'手の厥陰心包経':{'井':'PC9','滎':'PC8','兪':'PC7','経':'PC5','合':'PC3'},'手の少陽三焦経':{'井':'SJ1','滎':'SJ2','兪':'SJ3','経':'SJ6','合':'SJ10'},'足の少陽胆経':{'井':'GB44','滎':'GB43','兪':'GB41','経':'GB38','合':'GB34'},'足の厥陰肝経':{'井':'LV1','滎':'LV2','兪':'LV3','経':'LV4','合':'LV8'}};
  var PRESETS={'code->name':{qKey:'code',aKey:'name'},'name->location':{qKey:'name',aKey:'location'},'name->indications':{qKey:'name',aKey:'indications'},'code->location':{qKey:'code',aKey:'location'},'location->name':{qKey:'location',aKey:'name'}};

  function codeParts(code){
    var s=(code||'').toUpperCase().trim();
    var m=s.match(/^([A-Z]+)(\d+)$/); if(m) return {prefix:m[1],num:parseInt(m[2],10),raw:s};
    var m2=s.match(/^([A-Z]+)(\d+)/); if(m2) return {prefix:m2[1],num:parseInt(m2[2],10),raw:s};
    return {prefix:s,num:Number.MAX_SAFE_INTEGER,raw:s};
  }
  var PREFIX_ORDER=['CV','GV','LU','LI','ST','SP','HT','SI','BL','KI','PC','SJ','GB','LV'];
  var PREFIX_RANK=(function(){var o={};for(var i=0;i<PREFIX_ORDER.length;i++)o[PREFIX_ORDER[i]]=i;return o})();
  function prefixRank(p){p=(p||'').toUpperCase();return (p in PREFIX_RANK)?PREFIX_RANK[p]:999}

  function toast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(window._toastT);window._toastT=setTimeout(function(){t.classList.remove('show')},1500)}
  function save(){localStorage.setItem(STORAGE,JSON.stringify(data))}
  function load(){try{var raw=localStorage.getItem(STORAGE);if(raw){var arr=JSON.parse(raw);if(Array.isArray(arr))return arr}}catch(e){}return null}
  function csvEscape(s){if(s==null)s='';s=String(s);return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s}
  function truthyEnabled(v){ if(v===true||v===1||v==='1'||v==='true'||v==='TRUE') return true; if(v===false||v===0||v==='0'||v==='false'||v==='FALSE') return false; return true }
  function truthyEdited(v){ if(v===true||v===1||v==='1'||v==='true'||v==='TRUE') return 1; if(v===false||v===0||v==='0'||v==='false'||v==='FALSE') return 0; return 0 }

  // ===== 二層位置の表示値 =====
  function displayLocation(it){
    return (it.location_edit && it.location_edit.trim())
      ? it.location_edit.trim()
      : (it.location_who && it.location_who.trim())
        ? it.location_who.trim()
        : (it.location||''); // 旧データ互換
  }

  // ===== 学習ロジック =====
  var data=[],filtered=[];
  var session={list:[],i:0,mode:'flash',correct:0,wrong:0,showingAnswer:false,started:false,qKey:'name',aKey:'location',requeueWrong:true,order:'random'};
  function labelFor(k){return({code:'コード',name:'経穴名',location:'位置',indications:'主治'})[k]||k}
  function applyPreset(){var p=PRESETS[el('qaPreset').value]||PRESETS['name->location'];session.qKey=p.qKey;session.aKey=p.aKey}
  function clearStudyUI(){el('qText').textContent='「開始」を押してください';el('aText').innerHTML='';el('subText').textContent='';var area=el('mcqArea');area.innerHTML='';area.classList.add('hidden');el('progress').textContent='';session.showingAnswer=false}
  function endSession(){session.started=false; session.list=[]; session.i=0; session.correct=0; session.wrong=0; clearStudyUI(); toast('セッションを終了しました')}

  function applyPresetAndFilterPool(){
    applyPreset(); session.requeueWrong=el('requeueWrong').checked; session.order=el('order').value;
    var mer=el('filterMeridian').value; var shu=el('filterShu').value; var phase=el('filterPhase').value;
    var pool=data.slice();
    pool=pool.filter(function(x){ return truthyEnabled(x.enabled) });
    if(mer)pool=pool.filter(function(x){return (x.meridian||'')===mer});
    if(shu)pool=pool.filter(function(x){return (x.shu||'')===shu});
    if(phase)pool=pool.filter(function(x){return (x.phase||'')===phase});
    // 出題キー存在チェック（位置は表示値で判定）
    pool=pool.filter(function(x){
      var qv=(session.qKey==='location')?displayLocation(x):(x[session.qKey]||'');
      var av=(session.aKey==='location')?displayLocation(x):(x[session.aKey]||'');
      return (qv||'').trim() && (av||'').trim();
    });
    if(session.order==='code'){
      pool.sort(function(a,b){
        var pa=codeParts(a.code||''), pb=codeParts(b.code||'');
        var ra=prefixRank(pa.prefix), rb=prefixRank(pb.prefix);
        if(ra!==rb) return ra-rb;
        if(pa.num!==pb.num) return pa.num-pb.num;
        return (pa.raw||'').localeCompare(pb.raw||'');
      });
    }else{
      for(var i=pool.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=pool[i];pool[i]=pool[j];pool[j]=t}
    }
    return pool;
  }

  function start(forceReset){
    clearStudyUI();
    session.mode=el('mode').value;
    var pool=applyPresetAndFilterPool();
    var useMax=el('chkMax').checked;
    var limit=parseInt(el('limit').value||'20',10); if(isNaN(limit)||limit<1) limit=20;
    var finalLimit=useMax?pool.length:Math.min(Math.max(5,limit),Math.max(5,pool.length));
    session.list=pool.slice(0,finalLimit);
    session.i=0; session.correct=0; session.wrong=0; session.showingAnswer=false; session.started=session.list.length>0;
    if(!session.started){el('qText').textContent='該当データがありません';el('aText').textContent='出題形式・絞り込み・CSVをご確認ください';return}
    if(session.mode==='mcq') showMCQ(); else showFront(); updateProgress();
  }

  function current(){return session.list[session.i]}
  function showFront(){
    var it=current();
    var qv=(session.qKey==='location')?displayLocation(it):(it[session.qKey]||'—');
    el('qText').textContent=labelFor(session.qKey)+'：'+(qv||'—');
    el('aText').innerHTML='';
    el('subText').textContent='クリック／Enter／Space で裏面表示';
    el('mcqArea').classList.add('hidden');
    session.showingAnswer=false
  }
  function showBack(){
    var it=current();
    var av=(session.aKey==='location')?displayLocation(it):(it[session.aKey]||'—');
    el('qText').textContent=labelFor(session.aKey)+'：'+(av||'—');
    var sp=(it.shu&&it.phase)?'<span class="pill alt">五兪：'+it.shu+'</span><span class="pill alt">五行：'+it.phase+'</span>':'';
    el('aText').innerHTML='<span class="pill">'+(it.code||'')+'</span><span class="pill">'+(it.meridian||'')+'</span>'+sp
      +'<div><b>経穴名：</b>'+(it.name||'—')+'</div>'
      +'<div><b>位置（表示）：</b>'+displayLocation(it)+'</div>'
      + (it.location_edit?('<div class="small"><b>編集版：</b>'+it.location_edit+'</div>'):'')
      + (it.location_who?('<div class="small"><b>WHO原文：</b>'+it.location_who+'</div>'):'')
      +'<div><b>主治：</b>'+(it.indications||'—')+'</div><div><b>その他：</b>'+(it.memo||'—')+'</div>';
    el('subText').textContent='もう一度で表へ';el('mcqArea').classList.add('hidden');session.showingAnswer=true
  }
  function flip(){if(!session.started||!session.list.length){alert('まず「開始」を押してください');return}if(session.mode==='mcq'){return}if(session.showingAnswer)showFront();else showBack()}
  function updateProgress(){el('progress').textContent='進捗：'+(session.i+1)+'/'+session.list.length+'（正 '+session.correct+'・誤 '+session.wrong+'）'}
  function handleWrongRequeue(it){if(!session.requeueWrong) return;session.list.push(it)}
  function next(){session.i++;if(session.i>=session.list.length){el('qText').textContent='セッション完了！';el('aText').textContent='正解 '+session.correct+' / 不正解 '+session.wrong;el('subText').textContent='';el('mcqArea').classList.add('hidden');el('progress').textContent='';session.started=false;return}if(session.mode==='mcq')showMCQ();else showFront();updateProgress()}
  function markResult(ok){if(!session.started||!session.list.length){alert('まず「開始」を押してください');return}var it=current();if(ok){session.correct++;toast('正解')}else{session.wrong++;handleWrongRequeue(it);toast('不正解')}next()}
  function flashClick(){if(!session.started){start()}else if(session.mode==='flash'){flip()}}
  document.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();flashClick()}});

  // ===== 四択 =====
  function showMCQ(){
    var it=current();var qv=(session.qKey==='location')?displayLocation(it):(it[session.qKey]||'—');
    el('qText').textContent=labelFor(session.qKey)+'：'+(qv||'—');el('aText').textContent='';el('subText').textContent='';
    var area=el('mcqArea');area.innerHTML='';area.classList.remove('hidden');
    var opts=pickOptions(it,session.aKey);
    for(var i=0;i<opts.length;i++){
      (function(o){
        var av=(session.aKey==='location')?displayLocation(o):(o[session.aKey]||'（未設定）');
        var btn=document.createElement('button');btn.className='btn';btn.type='button';btn.textContent=av||'（未設定）';
        btn.onclick=function(){if(btn.dataset.done){next();return}if(o===it){btn.classList.add('correct');session.correct++;toast('正解')}else{btn.classList.add('wrong');session.wrong++;handleWrongRequeue(it);toast('不正解')}btn.dataset.done='1';setTimeout(next,320)};
        area.appendChild(btn)
      })(opts[i])
    }
  }
  function pickOptions(target,aKey){
    var pool=data.filter(function(x){
      return truthyEnabled(x.enabled) && ((aKey==='location')?displayLocation(x):(x[aKey]||'').trim());
    });
    var uniq=[],seen=new Set();
    for(var i=0;i<pool.length;i++){
      var x=pool[i];
      var v=(aKey==='location')?displayLocation(x):(x[aKey]||'');
      if(!seen.has(v)){uniq.push(x);seen.add(v)}
    }
    var opts=[target];
    while(opts.length<4&&uniq.length){var idx=Math.floor(Math.random()*uniq.length);var cand=uniq.splice(idx,1)[0];if(((aKey==='location')?displayLocation(cand):cand[aKey]) !== ((aKey==='location')?displayLocation(target):target[aKey]))opts.push(cand)}
    while(opts.length<4)opts.push(target);
    for(var j=opts.length-1;j>0;j--){var k=Math.floor(Math.random()*(j+1)),t=opts[j];opts[j]=opts[k];opts[k]=t}
    return opts
  }

  // ===== データ管理 =====
  function keyOf(d){return d.code||d.name||''}
  function indexByKey(k){for(var i=0;i<data.length;i++){if(keyOf(data[i])===k)return i}return -1}
  function deriveShuPhase(it){
    var mer=it.meridian||'';var code=(it.code||'').toUpperCase();
    for(var merName in SHU_POINTS){
      if(mer!==merName)continue;
      var map=SHU_POINTS[merName];
      for(var shu in map){
        var pcode=map[shu];
        if(code===pcode){
          var phase=(YIN.has(merName)?PHASE_SEQ_YIN:PHASE_SEQ_YANG)[['井','滎','兪','経','合'].indexOf(shu)];
          return{shu:shu,phase:phase}
        }
      }
    }
    return{shu:it.shu||'',phase:it.phase||''}
  }
  function ensureDefaults(d){
    if(typeof d.enabled==='undefined') d.enabled=true;
    if(typeof d.edited==='undefined') d.edited=0;
    d.location_who = d.location_who || d['位置(WHO原文)'] || '';
    d.location_edit = d.location_edit || d['位置(編集版)'] || '';
    return d;
  }
  function deriveAndFill(d){d=ensureDefaults(d);var a=deriveShuPhase(d);if(!d.shu)d.shu=a.shu;if(!d.phase)d.phase=a.phase;return d}
  function normalizeRow(tr){
    var obj={};
    var tds=tr.querySelectorAll('[data-key]');for(var i=0;i<tds.length;i++){var td=tds[i];obj[td.getAttribute('data-key')]=td.textContent.trim()}
    obj.enabled = tr.querySelector('.enabledBox')?.checked ? 1 : 0;
    obj.edited  = tr.querySelector('.editedBox')?.checked ? 1 : 0;
    var a=deriveShuPhase(obj);if(!obj.shu)obj.shu=a.shu;if(!obj.phase)obj.phase=a.phase;return obj
  }
  function applyEdit(tr,oldKey){
    var obj=normalizeRow(tr);var newKey=obj.code||obj.name||'';
    var idx=indexByKey(oldKey);if(idx===-1)idx=indexByKey(newKey);
    if(idx===-1){data.push(obj)}else{data[idx]=Object.assign({},data[idx],obj)}
    save();var c=tr.querySelector('.chkRow');if(c) c.dataset.key=newKey
  }

  function renderTable(){
    var q=(el('txtFind')?el('txtFind').value:'').trim().toLowerCase();
    filtered=data.filter(function(d){
      if(!q)return true;
      var s=[d.code||'',d.name||'',d.meridian||'',d.reading||'',d.location_who||'',d.location_edit||'',d.indications||'',d.memo||'',d.shu||'',d.phase||''].join(' ').toLowerCase();
      return s.indexOf(q)!==-1
    });
    var tb=el('tbody');if(!tb)return;tb.innerHTML='';
    for(var i=0;i<filtered.length;i++){
      var d=filtered[i];var key=d.code||d.name||'';var enabled=truthyEnabled(d.enabled);var edited=truthyEdited(d.edited);
      var tr=document.createElement('tr');
      tr.innerHTML='<td><input type="checkbox" class="chkRow" data-key="'+key+'"></td>'
        +'<td contenteditable="true" data-key="code">'+(d.code||'')+'</td>'
        +'<td contenteditable="true" data-key="name">'+(d.name||'')+'</td>'
        +'<td contenteditable="true" data-key="meridian">'+(d.meridian||'')+'</td>'
        +'<td contenteditable="true" data-key="reading">'+(d.reading||'')+'</td>'
        +'<td contenteditable="true" data-key="location_who">'+(d.location_who||'')+'</td>'
        +'<td contenteditable="true" data-key="location_edit">'+(d.location_edit||'')+'</td>'
        +'<td contenteditable="true" data-key="indications">'+(d.indications||'')+'</td>'
        +'<td contenteditable="true" data-key="memo">'+(d.memo||'')+'</td>'
        +'<td contenteditable="true" data-key="shu">'+(d.shu||'')+'</td>'
        +'<td contenteditable="true" data-key="phase">'+(d.phase||'')+'</td>'
        +'<td style="text-align:center"><input type="checkbox" class="editedBox" '+(edited? 'checked':'')+'></td>'
        +'<td style="text-align:center"><input type="checkbox" class="enabledBox" '+(enabled?'checked':'')+'></td>'
        +'<td><button class="btn" type="button" onclick="rowDup(\''+key.replace(/'/g,"\\'")+'\')">複製</button> <button class="btn danger" type="button" onclick="rowDel(\''+key.replace(/'/g,"\\'")+'\')">削除</button></td>';
      tr.addEventListener('blur',function(ev){var td=ev.target.closest('td[contenteditable=true]');if(!td)return;var row=td.closest('tr');var oldKey=row.querySelector('.chkRow')?.dataset.key||'';applyEdit(row,oldKey)},true);
      tr.querySelector('.enabledBox').addEventListener('change',function(ev){
        var row=ev.target.closest('tr');var k=row.querySelector('.chkRow')?.dataset.key||key;
        var idx=indexByKey(k); if(idx!==-1){data[idx].enabled=ev.target.checked?1:0;save();toast(ev.target.checked?'有効にしました':'無効にしました')}
      });
      tr.querySelector('.editedBox').addEventListener('change',function(ev){
        var row=ev.target.closest('tr');var k=row.querySelector('.chkRow')?.dataset.key||key;
        var idx=indexByKey(k); if(idx!==-1){data[idx].edited=ev.target.checked?1:0;save();toast(ev.target.checked?'編集済にしました':'未確認にしました')}
      });
      tb.appendChild(tr)
    }
    var all=el('chkAll');if(all)all.checked=false;
    el('info').textContent='登録：'+data.length+'件 / 表示：'+filtered.length+'件（無効は出題除外・位置は編集版優先）';
  }

  function rowDel(key){if(!confirm('削除しますか？'))return;var i=indexByKey(key);if(i!==-1){data.splice(i,1);save();refresh();toast('削除しました')}}
  function rowDup(key){
    var i=indexByKey(key);if(i===-1)return;var src=data[i];
    var c=(src.code||src.name||'COPY')+'_copy',k=1;while(indexByKey(c)!==-1){c=(src.code||src.name||'COPY')+'_copy'+(++k)}
    var copy=Object.assign({},src,{code:c});data.splice(i+1,0,copy);save();refresh();toast('複製しました')
  }
  function onCheckAll(box){var ch=document.querySelectorAll('.chkRow');for(var i=0;i<ch.length;i++){ch[i].checked=box.checked}}
  function onAddClick(){
    var base='NEW',n=1;while(indexByKey(base+n)!==-1)n++;
    data.unshift({code:base+n,name:'',meridian:'',reading:'',location_who:'',location_edit:'',indications:'',memo:'',shu:'',phase:'',edited:0,enabled:1});
    save();refresh()
  }

  // ===== エクスポート =====
  function onExportCSV(){
    var headers=['コード','経穴名','経絡','読み','位置(WHO原文)','位置(編集版)','主治','その他メモ','五兪穴','五行','編集済','有効'];
    var lines=[headers.join(',')];
    for(var i=0;i<data.length;i++){
      var d=data[i];
      var row=[
        d.code||'',d.name||'',d.meridian||'',d.reading||'',
        d.location_who||'',d.location_edit||'',
        d.indications||'',d.memo||'',d.shu||'',d.phase||'',
        truthyEdited(d.edited)?1:0, truthyEnabled(d.enabled)?1:0
      ].map(csvEscape).join(',');
      lines.push(row)
    }
    var blob=new Blob(['\ufeff'+lines.join('\n')],{type:'text/csv'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='keiketsu_data_v88.csv'; a.click(); URL.revokeObjectURL(url);
    toast('CSVを書き出しました')
  }
  function onExportJSON(){
    var arr=data.map(function(d){
      return{
        コード:d.code||'',経穴名:d.name||'',経絡:d.meridian||'',読み:d.reading||'',
        '位置(WHO原文)':d.location_who||'','位置(編集版)':d.location_edit||'',
        主治:d.indications||'',その他メモ:d.memo||'',五兪穴:d.shu||'',五行:d.phase||'',
        編集済:truthyEdited(d.edited)?1:0,有効:truthyEnabled(d.enabled)?1:0
      }
    });
    var blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='keiketsu_data_v88.json';a.click();URL.revokeObjectURL(url);
    toast('JSONを書き出しました')
  }

  // ===== インポート & 貼り付け =====
  async function onImportClick(){var fi=el('fileInput');if(!fi.files||!fi.files.length){alert('CSV/JSONを選択してください');return}await importFromFile(fi.files[0]);fi.value=''}
  function onBulkPasteOpen(){var d=el('dlgPaste');if(d.showModal)d.showModal();else d.setAttribute('open','')}
  function onPasteCancel(){var d=el('dlgPaste');if(d.close)d.close();else d.removeAttribute('open')}
  function onPasteApply(){var txt=el('taPaste').value||'';var n=importFromText(txt);onPasteCancel();toast('取り込み '+n+' 件')}

  function mapRowCommon(o){
    // 旧「位置」を入れてきたら編集版として扱う（互換）
    if(!o.location_edit && o.location){ o.location_edit = o.location; }
    return deriveAndFill(o);
  }

  async function importFromFile(file){
    var buf=await file.arrayBuffer();var text=new TextDecoder('utf-8',{fatal:false}).decode(buf);var arr=[];
    try{
      if(file.name.endsWith('.json')){
        var j=JSON.parse(text);
        arr=j.map(function(x){
          return mapRowCommon({
            code:x.id||x.code||x['コード']||'',
            name:x['経穴名']||x.name||'',
            meridian:x['経絡']||x.meridian||'',
            reading:x['読み']||x['経穴名_読み']||x.reading||'',
            // 二層
            location_who:x['位置(WHO原文)']||x.location_who||'',
            location_edit:x['位置(編集版)']||x.location_edit||'',
            // 旧互換
            location:x['位置']||x['部位メモ']||x.location||'',
            indications:x['主治']||x['主治メモ']||x.indications||'',
            memo:x['その他メモ']||x.memo||'',
            shu:x['五兪穴']||x.shu||'',
            phase:x['五行']||x.phase||'',
            edited: truthyEdited(x['編集済']||x.edited),
            enabled: truthyEnabled(x['有効']||x.enabled)
          })
        })
      }else{
        var rows=text.replace(/，/g,',').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(function(l){return l.trim().length>0});
        var headers=rows.shift().split(',').map(function(s){return s.trim()});
        var ix=function(k){return headers.indexOf(k)};
        for(var i=0;i<rows.length;i++){
          var r=rows[i].split(','), o;
          if(headers.indexOf('コード')!==-1){
            o={
              code:r[ix('コード')]||'',name:r[ix('経穴名')]||'',meridian:r[ix('経絡')]||'',reading:r[ix('読み')]||'',
              location_who: (ix('位置(WHO原文)')>=0 ? r[ix('位置(WHO原文)')] : ''),
              location_edit:(ix('位置(編集版)')>=0 ? r[ix('位置(編集版)')] : ''),
              location: (ix('位置')>=0 ? r[ix('位置')] : ''), // 旧互換
              indications:r[ix('主治')]||'',memo:(ix('その他メモ')>=0?r[ix('その他メモ)']:'')||r[ix('その他メモ')]||'',
              shu:(ix('五兪穴')>=0?r[ix('五兪穴')]:'')||'',phase:(ix('五行')>=0?r[ix('五行')]:'')||'',
              edited: truthyEdited(ix('編集済')>=0 ? r[ix('編集済')] : 0),
              enabled: truthyEnabled(ix('有効')>=0 ? r[ix('有効')] : 1)
            };
          }else if(headers.indexOf('id')!==-1){
            // 別ヘッダ互換
            o={
              code:r[ix('id')]||'',name:r[ix('経穴名')]||'',meridian:r[ix('経絡')]||'',reading:r[ix('経穴名_読み')]||'',
              location_who:(ix('位置(WHO原文)')>=0 ? r[ix('位置(WHO原文)')] : ''), location_edit:(ix('位置(編集版)')>=0 ? r[ix('位置(編集版)')] : ''),
              location:(ix('部位メモ')>=0 ? r[ix('部位メモ)']:'')||r[ix('部位メモ')]||'',
              indications:(ix('主治メモ')>=0?r[ix('主治メモ)']:'')||r[ix('主治メモ')]||'',
              memo:(ix('その他メモ')>=0?r[ix('その他メモ)']:'')||r[ix('その他メモ')]||'',
              shu:(ix('五兪穴')>=0?r[ix('五兪穴')]:'')||'',phase:(ix('五行')>=0?r[ix('五行')]:'')||'',
              edited: truthyEdited(ix('編集済')>=0 ? r[ix('編集済')] : 0),
              enabled: truthyEnabled(ix('有効')>=0 ? r[ix('有効')] : 1)
            };
          }else{
            // さらに旧いヘッダ
            o={code:r[ix('経穴コード')]||'',name:r[ix('経穴名')]||'',meridian:r[ix('経絡名')]||'',reading:r[ix('経穴名_読み')]||'',
               location_who:'', location_edit:'', location:r[ix('位置')]||'',
               indications:r[ix('主治')]||'',memo:'',shu:'',phase:'',edited:0,enabled:1};
          }
          arr.push(mapRowCommon(o));
        }
      }
    }catch(e){ alert('インポートに失敗：'+e.message); return }
    var mp=new Map(data.map(function(x){return [x.code||x.name,x]})); var add=0,upd=0;
    for(var i=0;i<arr.length;i++){var it=arr[i];var key=it.code||it.name;if(!key)continue;if(mp.has(key)){mp.set(key,Object.assign({},mp.get(key),it));upd++}else{mp.set(key,it);add++}}
    data=Array.from(mp.values()); save(); refresh(); toast('インポート：追加 '+add+'・更新 '+upd+'・全 '+data.length);
  }

  function importFromText(text){
    var lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(function(l){return l.trim().length>0});
    if(!lines.length) return 0;
    var headers=lines[0].indexOf(',')>=0?lines.shift().split(',').map(function(s){return s.trim()}):['コード','経穴名','経絡','読み','位置(WHO原文)','位置(編集版)','主治','その他メモ','五兪穴','五行','編集済','有効'];
    var ix=function(k){return headers.indexOf(k)}; var count=0; var mp=new Map(data.map(function(x){return [x.code||x.name,x]}));
    for(var i=0;i<lines.length;i++){
      var r=lines[i].split(','), o={
        code:r[ix('コード')]||'', name:r[ix('経穴名')]||'', meridian:r[ix('経絡')]||'', reading:r[ix('読み')]||'',
        location_who:(ix('位置(WHO原文)')>=0?r[ix('位置(WHO原文)')]:'')||'',
        location_edit:(ix('位置(編集版)')>=0?r[ix('位置(編集版)')]:'')||'',
        location:(ix('位置)')>=0?r[ix('位置)')]:'')||(ix('位置')>=0?r[ix('位置')]:'')||'', // 旧互換
        indications:(ix('主治)')>=0?r[ix('主治)')]:'')||r[ix('主治')]||'',
        memo:(ix('その他メモ)')>=0?r[ix('その他メモ)')]:'')||r[ix('その他メモ')]||'',
        shu:(ix('五兪穴)')>=0?r[ix('五兪穴)')]:'')||r[ix('五兪穴')]||'',
        phase:(ix('五行)')>=0?r[ix('五行)')]:'')||r[ix('五行')]||'',
        edited: truthyEdited(ix('編集済')>=0 ? r[ix('編集済')] : 0),
        enabled: truthyEnabled(ix('有効')>=0 ? r[ix('有効')] : 1)
      };
      o=mapRowCommon(o);
      var key=o.code||o.name; if(!key) continue;
      mp.set(key,Object.assign({},mp.get(key)||{},o)); count++;
    }
    data=Array.from(mp.values()); save(); refresh(); return count;
  }

  // ===== 初期化 =====
  async function importSeed(){
    try{
      var saved=load(); if(saved&&saved.length){ data=saved.map(ensureDefaults); return }
      var tag=el('seedData'); if(!tag) throw new Error('seedData が見つかりません');
      var arr=JSON.parse(tag.textContent);
      data=arr.map(function(x){
        // 旧版互換（location→編集版に昇格）
        if(x.location && !x.location_edit) x.location_edit = x.location;
        return deriveAndFill({
          code:x.code||'',name:x.name||'',meridian:x.meridian||'',reading:x.reading||'',
          location_who:x.location_who||x['位置(WHO原文)']||'',
          location_edit:x.location_edit||x['位置(編集版)']||'',
          indications:x.indications||'',memo:x.memo||'',shu:x.shu||'',phase:x.phase||'',
          edited: truthyEdited(x.edited||x['編集済']), enabled: truthyEnabled(x.enabled||x['有効'])
        });
      });
      save();
    }catch(e){
      alert('初期データ読込に失敗：'+e.message);
      data=[]; save();
    }
  }
  (async function(){ await importSeed(); refresh(); })();

  function refresh(){
    for(var i=0;i<data.length;i++) data[i]=deriveAndFill(data[i]);
    var mer=Array.from(new Set(data.map(function(d){return d.meridian}).filter(Boolean))).sort();
    el('filterMeridian').innerHTML='<option value="">（すべて）</option>'+mer.map(function(m){return '<option>'+m+'</option>'}).join('');
    renderTable();
  }
  </script>
  <!-- ==== /アプリ本体 JS ==== -->
</body>
</html>
