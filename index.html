<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Keiketsu Mini v9.8</title>
<style>
body {font-family: sans-serif; margin:0; padding:0; background:#f8f9fb;}
header {background:#1976d2; color:white; padding:0.5em 1em; font-size:18px; font-weight:bold; display:flex; align-items:center;}
nav {display:flex; background:#2196f3;}
nav button {flex:1; padding:0.6em; border:none; background:#2196f3; color:white; font-size:16px; cursor:pointer;}
nav button.active {background:#1976d2; font-weight:bold;}
section {display:none; padding:1em;}
section.active {display:block;}
h2 {margin-top:0;}
table {border-collapse:collapse; min-width:1200px;}
th, td {border:1px solid #ccc; padding:4px; font-size:13px;}
th {background:#eee;}
input[type="text"] {width:100%;}
#toast {visibility:hidden; min-width:160px; background:#333; color:#fff; text-align:center;
  border-radius:2px; padding:8px; position:fixed; z-index:1; left:50%; bottom:30px;
  transform:translateX(-50%);}
#toast.show {visibility:visible; animation:fadein 0.5s, fadeout 0.5s 1.5s;}
@keyframes fadein {from{bottom:0;opacity:0} to{bottom:30px;opacity:1}}
@keyframes fadeout {from{bottom:30px;opacity:1} to{bottom:0;opacity:0}}
/* 横スクロール */
.hscroll-top {overflow-x:auto; overflow-y:hidden; height:16px;}
.hscroll-dummy {height:1px;}
.grid-wrapper {overflow:auto; border:1px solid #ccc; max-height:400px;}
.btn {padding:0.3em 0.6em; margin:2px; border:1px solid #aaa; border-radius:4px; background:#eee; cursor:pointer;}
.btn:hover {background:#ddd;}
</style>
</head>
<body>
<header>Keiketsu Mini v9.8</header>
<nav>
  <button id="tabStudy" onclick="switchView('viewStudy','tabStudy')" class="active">学習</button>
  <button id="tabManage" onclick="switchView('viewManage','tabManage')">データ管理</button>
  <button id="tabAbout" onclick="switchView('viewAbout','tabAbout')">説明</button>
</nav>

<!-- 学習 -->
<section id="viewStudy" class="active">
  <h2>学習モード</h2>
  <label>出題形式:
    <select id="mode">
      <option value="flash">フラッシュカード</option>
      <option value="mcq">四択クイズ</option>
    </select>
  </label>
  <label>順序:
    <select id="order">
      <option value="random">ランダム</option>
      <option value="code">コード順</option>
    </select>
  </label>
  <label>出題数: <input id="limit" type="number" value="20" style="width:4em;"> <input id="chkMax" type="checkbox">最大</label>
  <label><input type="checkbox" id="requeueWrong" checked>間違えた問題を最後に再出題</label><br>
  <button onclick="start()">開始</button>
  <button onclick="endSession()">終了</button>
  <div id="qText" style="margin-top:1em;font-weight:bold;">「開始」を押してください</div>
  <div id="aText" style="white-space:pre-line;"></div>
  <div id="subText" style="color:#666;"></div>
  <div id="mcqArea" class="hidden"></div>
  <div id="progress" style="margin-top:1em;"></div>
  <button onclick="markResult(true)">正解</button>
  <button onclick="markResult(false)">不正解</button>
</section>

<!-- データ管理 -->
<section id="viewManage">
  <h2>データ管理</h2>
  <input type="file" id="fileInput" accept=".csv,.json">
  <button onclick="onImportClick()">インポート</button>
  <button onclick="onExportCSV()">CSVエクスポート</button>
  <button onclick="onExportJSON()">JSONエクスポート</button>
  <button onclick="onDeleteSelected()">チェック削除</button>
  <div id="hscrollTop" class="hscroll-top"><div id="hscrollDummy" class="hscroll-dummy"></div></div>
  <div id="gridMain" class="grid-wrapper">
    <table id="dataTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="chkAll" onchange="onCheckAll(this)"></th>
          <th>コード</th><th>経穴名</th><th>経絡</th><th>読み</th>
          <th>位置</th><th>主治</th><th>その他メモ</th>
          <th>五兪穴</th><th>五行</th><th>操作</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div id="info"></div>
</section>

<!-- 説明 -->
<section id="viewAbout">
  <h2>説明</h2>
  <p>経穴学習用のミニアプリです。<br>
  ・CSV/JSONインポートでデータを追加可能<br>
  ・出題形式：フラッシュカード／四択<br>
  ・「コード順」で CV→GV→LU→LI→… の順に並びます</p>
</section>

<div id="toast"></div>

<script>
// ===== ユーティリティ =====
const el=id=>document.getElementById(id);
function toast(msg){let t=el('toast');t.textContent=msg;t.classList.add('show');
 setTimeout(()=>t.classList.remove('show'),2000);}
function switchView(viewId,tabId){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  el(viewId).classList.add('active');
  el(tabId).classList.add('active');
  if(viewId==='viewManage'){
    requestAnimationFrame(()=>requestAnimationFrame(adjustTop));
  }
}

// ===== 上部スクロール同期 =====
function adjustTop(){
  const grid=el('gridMain'), top=el('hscrollTop'), dum=el('hscrollDummy'), tbl=el('dataTable');
  if(!grid||!top||!dum||!tbl)return;
  dum.style.width=(tbl.scrollWidth||1200)+'px';
  const sbw=grid.offsetWidth-grid.clientWidth;
  top.style.paddingRight= sbw>0 ? (sbw+'px'):'0px';
}

// ===== データ管理（簡易） =====
let data=[
  {code:'LU1',name:'中府',meridian:'手の太陰肺経',reading:'ちゅうふ',location:'鎖骨下窩にあり',indications:'咳、喘息',memo:'サンプル',shu:'井',phase:'木'},
  {code:'LI4',name:'合谷',meridian:'手の陽明大腸経',reading:'ごうこく',location:'第1・2中手骨間',indications:'頭痛、歯痛',memo:'サンプル',shu:'原',phase:''},
  {code:'ST36',name:'足三里',meridian:'足の陽明胃経',reading:'あしさんり',location:'犢鼻下3寸',indications:'胃腸症状',memo:'サンプル',shu:'合',phase:'土'}
];
function renderTable(){
  const tb=el('tbody');tb.innerHTML='';
  for(const d of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" class="chkRow" data-key="${d.code}"></td>
      <td contenteditable="true" data-key="code">${d.code||''}</td>
      <td contenteditable="true" data-key="name">${d.name||''}</td>
      <td contenteditable="true" data-key="meridian">${d.meridian||''}</td>
      <td contenteditable="true" data-key="reading">${d.reading||''}</td>
      <td contenteditable="true" data-key="location">${d.location||''}</td>
      <td contenteditable="true" data-key="indications">${d.indications||''}</td>
      <td contenteditable="true" data-key="memo">${d.memo||''}</td>
      <td contenteditable="true" data-key="shu">${d.shu||''}</td>
      <td contenteditable="true" data-key="phase">${d.phase||''}</td>
      <td><button onclick="rowDup('${d.code}')">複製</button></td>`;
    tb.appendChild(tr);
  }
  el('info').textContent=`登録：${data.length}件`;
  adjustTop();
}
function onCheckAll(box){document.querySelectorAll('.chkRow').forEach(c=>c.checked=box.checked);}
function onDeleteSelected(){
  const keys=Array.from(document.querySelectorAll('.chkRow:checked')).map(c=>c.dataset.key);
  if(!keys.length){alert('削除対象なし');return;}
  data=data.filter(d=>!keys.includes(d.code));
  renderTable();
  toast('削除しました');
}
function rowDup(code){
  const d=data.find(x=>x.code===code);
  if(!d)return;
  const copy=Object.assign({},d,{code:code+'_copy'});
  data.push(copy);renderTable();toast('複製しました');
}

// ===== 学習 =====
let session={started:false,list:[],i:0,mode:'flash',order:'random',requeueWrong:true,correct:0,wrong:0,showingAnswer:false};
function start(){
  session.mode=el('mode').value; session.order=el('order').value;
  let pool=data.slice();
  if(session.order==='code') pool.sort((a,b)=>a.code.localeCompare(b.code));
  session.list=pool.slice(0,parseInt(el('limit').value||'20',10));
  session.i=0; session.correct=0; session.wrong=0; session.started=true;
  if(session.mode==='mcq') showMCQ(); else showFront();
}
function endSession(){session.started=false;el('qText').textContent='終了しました';}
function current(){return session.list[session.i];}
function showFront(){let it=current();el('qText').textContent=it.name;el('aText').textContent='';el('subText').textContent='クリックで裏面';session.showingAnswer=false;}
function showBack(){let it=current();el('qText').textContent=it.location;el('aText').textContent=it.indications;el('subText').textContent='もう一度で表へ';session.showingAnswer=true;}
function flip(){if(session.showingAnswer)showFront();else showBack();}
document.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();flip();}});
function markResult(ok){if(ok)session.correct++;else session.wrong++;next();}
function next(){session.i++;if(session.i>=session.list.length){el('qText').textContent='完了';return;}if(session.mode==='mcq')showMCQ();else showFront();}
function showMCQ(){let it=current();el('qText').textContent=it.name;el('aText').textContent='四択UI未実装';}

// ===== 初期化 =====
function init(){
  renderTable();
  // ResizeObserverで同期
  const grid=el('gridMain'), tbl=el('dataTable');
  if(window.ResizeObserver){const ro=new ResizeObserver(adjustTop);ro.observe(grid);ro.observe(tbl);}
  const tbody=el('tbody');
  if(window.MutationObserver){const mo=new MutationObserver(adjustTop);mo.observe(tbody,{childList:true});}
  setTimeout(adjustTop,0);setTimeout(adjustTop,200);setTimeout(adjustTop,600);
}
init();
</script>
</body>
</html>
